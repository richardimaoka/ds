<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
<meta content="Asciidoctor 1.5.2" name="generator" />
<title>DS220: Data Modeling</title>
<link href="deck.js/themes/style/font.css" rel="stylesheet" />
<style>
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 1.2em; height: 1.2em; font-size: 0.9em; font-weight: bold; line-height: 1.2; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -0.1em; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }
.colist table td:first-of-type { padding-right: 0.25em; }
</style>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{font-weight: normal}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#00}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<link href="deck.js/core/deck.core.css" rel="stylesheet" />
<link href="deck.js/extensions/scale/deck.scale.css" media="screen" rel="stylesheet" />
<link href="deck.js/extensions/goto/deck.goto.css" media="screen" rel="stylesheet" />
<link href="deck.js/themes/style/datastax.css" media="screen" rel="stylesheet" />
<link href="deck.js/themes/transition/fade.css" media="screen" rel="stylesheet" />
<link href="deck.js/core/print.css" media="print" rel="stylesheet" />
<script src="deck.js/modernizr.custom.js"></script>
</head>
<body class="article">
<div class="deck-container">
<section class="slide" id="title-slide">
<h1>DS220: Data Modeling</h1>
</section>
<section class="slide" id="courses-DS220-course-introduction">
<h2>Student Introduction</h2>
<div class="ulist">
<ul>
<li>Name</li>
<li>Where you are from</li>
<li>Where you work</li>
<li>Goals for using Cassandra</li>
<li>Prior experience</li>
<li>Personal trivia</li>
</ul>
</div>
</section>
<section class="slide" id="learning-objectives">
<h2>Learning Objectives</h2>
<div class="ulist">
<ul>
<li class="slide">Explore KillrVideo domain</li>
<li class="slide">Build our database using quick design techniques</li>
<li class="slide"><p>
Improve our model using a query driven methodology<div class="ulist">
<ul>
<li>Conceptual</li>
<li>Logical</li>
<li>Physical</li>
</ul>
</div></p></li>
<li class="slide">Optimize our model via analysis and validation techniques</li>
</ul>
</div>
</section>
<section class="slide" id="courses-DS220-data-modeling-overview">
<h2>Data Modeling</h2>
<div class="paragraph"><p><span class="image"><img alt="overview\business" src="images/courses/DS220/data-modeling/overview/business.jpg" /></span></p></div>
<div class="ulist">
<ul>
<li>Analyze requirements</li>
<li>Identify entities and relationships</li>
<li>Identify queries</li>
<li>Specify the schema</li>
<li>Optimize, optimize, optimize</li>
<li>CQL</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="overview\business" src="images/courses/DS220/data-modeling/overview/business.jpg" /></span></p></div>
<div class="ulist">
<ul>
<li>Analyze requirements</li>
<li>Identify entities and relationships&#8212;&#8203;conceptual data model</li>
<li>Identify queries&#8212;&#8203;application workflow</li>
<li>Specify the schema&#8212;&#8203;logical data model</li>
<li>Optimize, optimize, optimize&#8212;&#8203;physical data model</li>
<li>CQL</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="overview\business" src="images/courses/DS220/data-modeling/overview/business.jpg" /></span></p></div>
<div class="paragraph"><p><span class="image"><img alt="overview\data-model-flow" src="images/courses/DS220/data-modeling/overview/data-model-flow.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="overview\mad-scientist" src="images/courses/DS220/data-modeling/overview/mad-scientist.jpg" /></span></p></div>
<div class="ulist">
<ul>
<li><p>
Data modeling is a science<div class="ulist">
<ul>
<li>Apply tested methodologies</li>
<li>Make improvements</li>
<li>Reproducible!</li>
</ul>
</div></p></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="overview\artist" src="images/courses/DS220/data-modeling/overview/artist.jpg" /></span></p></div>
<div class="ulist">
<ul>
<li><p>
Data modeling is also an art<div class="ulist">
<ul>
<li>Think outside of the box</li>
<li>Non-standard solution&#8212;&#8203;requires creativity</li>
<li>Be careful&#8212;&#8203;different data models have different costs</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Data modeling is the process of collecting and analyzing data requirements in an information system. We identify domain objects, relationships between them, and how we query this information. This process is key to designing our database system.</p></div>
<div class="paragraph"><p>Data modeling is a cross between science and art. Science is reproducible whereas art is the creative component to tackle non-standard problems. Science applies formalized patterns to common problems whereas art reproductions are not worth much. (But they make you look cool!)</p></div>
<div class="paragraph"><p>Different data models can solve the needs of the domain, however some could be costlier than others because they require more notes and machines.</p></div>
</div>
</div>
</section>
<section class="slide" id="queries">
<h2>Queries</h2>
<div class="paragraph"><p><strong>Lightening fast queries are the goal!</strong></p></div>
<div class="ulist">
<ul>
<li>Differs from relational&#8212;&#8203;queries take center stage in schema design</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="lightening-4up-horizontal" src="images/courses/DS220/data-modeling/overview/lightening-4up-horizontal.png" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Designing a relational database schema begins with the focus on the object types, their attributes, and how that maps to tables. Queries are usually an afterthought.</p></div>
<div class="paragraph"><p>Designing a Cassandra database scheme focuses early on the queries and making their speed a first priority. We structure Cassandra tables to support queries rather than represent domain object types.</p></div>
<div class="paragraph"><p>Doing it right now means we scale and have consistent spped, our model could be fast now, but may not scale well and needs to be considered.</p></div>
</div>
</div>
</section>
<section class="slide" id="data-suited-for-cassandra">
<h2>Data Suited for Cassandra</h2>
<div class="ulist">
<ul>
<li>Most domains</li>
<li>Transactional or operational data</li>
<li>Demands of web, mobile, and internet of things (IOT)</li>
<li>High availability!</li>
<li>Scale!</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Big Data</strong></p></div>
<div class="paragraph"><p><span class="image"><img alt="big-data" src="images/courses/DS220/data-modeling/overview/big-data.png" /></span></p></div>
<div class="ulist">
<ul>
<li>Volume (petabytes of data, trillions of entities)</li>
<li>Velocity (real-time, streams, millions of transactions per second)</li>
<li>Variety (un-, semi-, structured)</li>
<li>&#8230;&#8203;what relational databases cannot handle</li>
</ul>
</div>
</section>
<section class="slide" id="you">
<h2>You!</h2>
<div class="paragraph"><p><span class="image"><img alt="magician" src="images/courses/DS220/data-modeling/overview/magician.jpg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="break-dancer" src="images/courses/DS220/data-modeling/overview/break-dancer.jpg" /></span></p></div>
</section>
<section class="slide" id="or-maybe">
<h2>Or maybe&#8230;&#8203;</h2>
<div class="paragraph"><p><span class="image"><img alt="nerd" src="images/courses/DS220/data-modeling/overview/nerd.jpg" /></span></p></div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-1">
<h2>Exercise 1&#8212;&#8203;Setting up your environment</h2>

</section>
<section class="slide transition-green" id="courses-DS220-data-modeling-overview-killrvideo-story">
<h2>KillrVideo Story</h2>

</section>
<section class="slide" id="killrvideo-inc">
<h2>KillrVideo, Inc.</h2>
<div class="paragraph"><p><strong>KillrVideo is a video sharing website</strong></p></div>
<div class="paragraph"><p><span class="image"><img alt="killrvideo-features" src="images/courses/DS220/data-modeling/overview/killrvideo-story/killrvideo-features.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Features:</p></div>
<div class="ulist">
<ul>
<li>User accounts/user ratings/user comments</li>
<li><p>
Movies and TV shows<div class="ulist">
<ul>
<li>Trailers available for preview</li>
<li>Movies and TV shows licensed from publishers</li>
<li>Parental restrictions based on video&#8217;s MPAA rating or parental guidelines</li>
</ul>
</div></p></li>
<li>Encoding to accommodate playback on mobile devices as well as large TVs</li>
<li>Search videos per user or by title, year, actor, director, genre</li>
<li>Playback tracking allowing pausing and continuing videos at a later date</li>
</ul>
</div>
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The KillrVideo domain has several features we see listed here. Most notably KillrVideo not only stores licensed content but also user-generated content as well. There are other typical video-sharing features such as parental controls, searching, and also tracking where users left off while watching a video.</p></div>
</div>
</div>
</section>
<section class="slide" id="problems-killrvideo-faces">
<h2>Problems KillrVideo Faces</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="frustrated-user" src="images/courses/DS220/data-modeling/overview/killrvideo-story/frustrated-user.jpg" /></span></p></div>
<div class="ulist">
<ul>
<li>Scalability&#8212;&#8203;KillrVideo constantly adds users and videos</li>
<li>Reliability&#8212;&#8203;KillrVideo must always be available</li>
<li>Ease of use&#8212;&#8203;KillrVideo must be easy to manage and maintain</li>
</ul>
</div>
<div class="paragraph notes"><p>KillrVideo found too much success too early and is frantically trying to keep up with its growth. Users constantly push new content, consume content, etc. The KillrVideo team needs a simple mechanism to store/retrieve this content which continues coming at a fast pace.</p></div>
</section>
<section class="slide" id="solutions-attempted">
<h2>Solutions Attempted</h2>
<div class="paragraph"><p><strong>Relational Database Problems</strong></p></div>
<div class="imageblock float-right">
<div class="content">
<img alt="relational problems" src="images/courses/DS220/data-modeling/overview/killrvideo-story/relational-problems.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Single points of failure</li>
<li>Scaling complexity</li>
<li>Reliability issues</li>
<li>Difficult to serve users worldwide</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Currently KillrVideo stores its data in a relational database. However, this leader/follower architecture causes a single point of failure when the database crashes.</p></div>
<div class="paragraph"><p>KillrVideo also found that scaling their relational database is doable but difficult. Users on the other side of the world experience lag on the site simply because of their geographical location. Ideally the KillrVideo team could store their data in both the eastern and western hemispheres so all users can enjoy a pleasant viewing experience.</p></div>
</div>
</div>
</section>
<section class="slide" id="killrvideo-and-cassandra">
<h2>KillrVideo and Cassandra</h2>
<div class="paragraph"><p><strong>Why Cassandra</strong></p></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="nodes" src="images/courses/DS220/data-modeling/overview/killrvideo-story/nodes.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Peers instead of leader/follower</li>
<li>Linear scale performance</li>
<li>Always on reliability</li>
<li>Data can be stored geographically close to clients</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>KillrVideo needs to migrate to Cassandra to solve all of these problems. Cassandra uses nodes in a peer-to-peer fashion rather than a single centralized leader/follower database. Cassandra also scales linearly with the number of nodes KillrVideo adds to the system. Cassandra is always on because when some nodes fail, the others pick up the slack. Using Cassandra, KillrVideo can easily locate its nodes geographically to the users' physical location.</p></div>
</div>
</div>
</section>
<section class="slide transition-green" id="courses-DS220-transitions-challenge-transition">
<h2>KillrVideo Challenges</h2>

</section>
<section class="slide" id="courses-DS220-data-modeling-data-modeling-wins-challenge-1">
<h2>KillrVideo Challenge 1</h2>
<div class="paragraph"><p><strong>Load KillrVideo video data</strong></p></div>
<div class="ulist">
<ul>
<li>Keyspaces</li>
<li>Tables</li>
<li>Basic data types</li>
<li>Importing CSV files</li>
<li>SELECT</li>
</ul>
</div>
</section>
<section class="slide" id="keyspaces">
<h2>Keyspaces</h2>
<div class="ulist">
<ul>
<li>Top-level namespace/container</li>
<li>Similar to a relational database schema</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> KEYSPACE killrvideo
WITH REPLICATION = {
  <span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">SimpleStrategy</span><span class="delimiter">'</span></span>,
  <span class="string"><span class="delimiter">'</span><span class="content">replication_factor</span><span class="delimiter">'</span></span> : <span class="integer">1</span>
};</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>Replication parameters required</li>
</ul>
</div>
</section>
<section class="slide" id="use">
<h2>USE</h2>
<div class="ulist">
<ul>
<li>USE switches between keyspaces</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql">USE killrvideo;</code></pre>
</div>
</div>
</section>
<section class="slide" id="tables">
<h2>Tables</h2>
<div class="ulist">
<ul>
<li>Keyspaces contain tables</li>
<li>Tables contain data</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> table1 (
  column1 <span class="predefined-type">TEXT</span>,
  column2 <span class="predefined-type">TEXT</span>,
  column3 <span class="predefined-type">INT</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> (column1)
);

<span class="class">CREATE</span> <span class="type">TABLE</span> users (
  user_id UUID,
  first_name <span class="predefined-type">TEXT</span>,
  last_name <span class="predefined-type">TEXT</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> (user_id)
);</code></pre>
</div>
</div>
</section>
<section class="slide" id="primary-keys">
<h2>Primary Keys</h2>
<div class="paragraph right"><p><span class="image" style="float: right"><img alt="primary-key" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-1/primary-key.svg" /></span></p></div>
<div class="listingblock left">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> users (
  user uuid,
  email <span class="predefined-type">text</span>,
  name <span class="predefined-type">text</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> (user)
);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>Uniquely identify rows</li>
</ul>
</div>
</section>
<section class="slide" id="basic-data-types">
<h2>Basic Data Types</h2>
<div class="ulist">
<ul>
<li><p>
text<div class="ulist">
<ul>
<li>UTF8 encoded string</li>
<li>varchar is same as text</li>
</ul>
</div></p></li>
<li><p>
int<div class="ulist">
<ul>
<li>Signed</li>
<li>32 bits</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="uuid-timeuuid">
<h2>UUID &amp; TIMEUUID</h2>
<div class="ulist">
<ul>
<li><p>
Universally Unique Identifier<div class="ulist">
<ul>
<li>Ex: 52b11d6d-16e2-4ee2-b2a9-5ef1e9589328</li>
<li>Generate via uuid()</li>
</ul>
</div></p></li>
<li><p>
TIMEUUID embeds a TIMESTAMP value<div class="ulist">
<ul>
<li>Ex: 1be43390-9fe4-11e3-8d05-425861b86ab6</li>
<li>Sortable</li>
<li>Generate via now()</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Use in place of integer IDs because Cassandra is a distributed database.</p></div>
<div class="paragraph"><p>Value format: hex{8}-hex{4}-hex{4}-hex{4}-hex{12}. UUID is called GUID by some developers.</p></div>
<div class="paragraph"><p>There are different versions/formats of UUIDs. The first digit in the third group of digits indicates the version number. Cassandra&#8217;s TIMEUUID is version 1 and generated using time (60 bits), a clock sequence number (14 bits), and a MAC address (48 bits). Cassandra&#8217;s UUID is version 4 and simply creates unique values.</p></div>
<div class="paragraph"><p>You can order on a TIMEUUID to produce time-ordered data.</p></div>
<div class="paragraph"><p>CQL&#8217;s dateOf() function extracts the time portion of a TIMEUUID.</p></div>
</div>
</div>
</section>
<section class="slide" id="timestamp">
<h2>TIMESTAMP</h2>
<div class="ulist">
<ul>
<li>Stores date and time</li>
<li>64-bit integer</li>
<li>Milliseconds since January 1 1970 at 00:00:00 GMT</li>
<li>Displayed in cqlsh as yyyy-mm-dd HH:mm:ssZ</li>
<li>As literal in cqlsh is '1979-07-24 08:30:15'</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>TIMESTAMP stores date and time</li>
<li>64-bit integer</li>
<li>Number of milliseconds January 1 1970 at 00:00:00 GMT</li>
<li>String literal in the  ISO 8601 format</li>
<li>1979-12-18 08:12:51-0400</li>
<li>2014-02-27</li>
<li>Other variations allowed</li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide" id="copy">
<h2>COPY</h2>
<div class="ulist">
<ul>
<li>Imports/exports CSV (comma-separated values)</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql">COPY table1 (column1, column2, column3) <span class="keyword">FROM</span> <span class="string"><span class="delimiter">'</span><span class="content">table1data.csv</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>Header parameter skips the first line in the file</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql">COPY table1 (column1, column2, column3) <span class="keyword">FROM</span> <span class="string"><span class="delimiter">'</span><span class="content">table1data.csv</span><span class="delimiter">'</span></span>
WITH HEADER=<span class="predefined-constant">true</span>;</code></pre>
</div>
</div>
</section>
<section class="slide" id="select">
<h2>SELECT</h2>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> *
<span class="keyword">FROM</span> table1;

<span class="class">SELECT</span> column1, column2, column3
<span class="keyword">FROM</span> table1;

<span class="class">SELECT</span> <span class="predefined">COUNT</span>(*)
<span class="keyword">FROM</span> table1;

<span class="class">SELECT</span> *
<span class="keyword">FROM</span> table1
LIMIT <span class="integer">10</span>;</code></pre>
</div>
</div>
<div class="paragraph notes"><p>COUNT() performs a table scan. Table scans are not optimal, thus, COUNT has a hard limit of 10,000 but can be increased using LIMIT.</p></div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-2-challenge-1">
<h2>Exercise 2&#8212;&#8203;KillrVideo Challenge 1</h2>

</section>
<section class="slide" id="courses-DS220-data-modeling-data-modeling-wins-challenge-2">
<h2>KillrVideo Challenge 2</h2>
<div class="paragraph"><p><strong>Query videos by title and year</strong></p></div>
<div class="ulist">
<ul>
<li>Partitions</li>
<li>Partition keys</li>
<li>Composite partition keys</li>
</ul>
</div>
</section>
<section class="slide" id="query">
<h2>Query</h2>
<div class="paragraph"><p>Let&#8217;s try the following queries on the <code>videos</code> table:</p></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="database" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/database.jpg" width="50%" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> *
<span class="keyword">FROM</span> videos
<span class="keyword">WHERE</span> title = <span class="string"><span class="delimiter">'</span><span class="content">The Original Grumpy Cat</span><span class="delimiter">'</span></span>;

<span class="class">SELECT</span> *
<span class="keyword">FROM</span> videos
<span class="keyword">WHERE</span> added_date  &lt; <span class="string"><span class="delimiter">'</span><span class="content">2015-05-01</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph notes"><p>Both of these queries fail. This is a hands-on intro into how Cassandra&#8217;s physical storage strategy differs from relational database systems.</p></div>
</section>
<section class="slide" id="errors">
<h2>Errors</h2>
<div class="ulist">
<ul>
<li>These queries fail because of Cassandra&#8217;s underlying storage strategy</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="errors" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/errors.png" width="135%" /></span></p></div>
</section>
<section class="slide" id="videos">
<h2>Videos</h2>
<div class="paragraph"><p><strong>Simpler videos schema for demo purposes</strong></p></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="challenge-2\typical-relational-table" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/typical-relational-table.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> videos (
  id <span class="predefined-type">int</span>,
  name <span class="predefined-type">text</span>,
  runtime <span class="predefined-type">int</span>,
  <span class="predefined-type">year</span> <span class="predefined-type">int</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> (id)
);</code></pre>
</div>
</div>
</section>
<section class="slide" id="cassandra-s-physical-storage-strategy">
<h2>Cassandra’s Physical Storage Strategy</h2>
<div class="paragraph"><p><span class="image"><img alt="cassandra-physical-storage-strategy-1" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/cassandra-physical-storage-strategy-1.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="cassandra-physical-storage-strategy-2" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/cassandra-physical-storage-strategy-2.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="cassandra-physical-storage-strategy-3" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/cassandra-physical-storage-strategy-3.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="cassandra-physical-storage-strategy-4" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/cassandra-physical-storage-strategy-4.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="cassandra-physical-storage-strategy-5" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/cassandra-physical-storage-strategy-5.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="cassandra-physical-storage-strategy-6" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/cassandra-physical-storage-strategy-6.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li><strong>Partition</strong> - Maps a <strong>partition key</strong> to a sequence of cells</li>
<li><strong>Cell</strong> - a key-value pair</li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide" id="cql-tables">
<h2>CQL Tables</h2>
<div class="paragraph"><p><span class="image"><img alt="cql-tables-1" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/cql-tables-1.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="cql-tables-2" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/cql-tables-2.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>CQL displays partition data in a tabular format called a <strong>table</strong>.</li>
<li>CQL tables appear similar to relational tables, but the comparison diverges there.</li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide" id="determining-partition-keys">
<h2>Determining Partition Keys</h2>
<div class="ulist">
<ul>
<li>CQL&#8217;s PRIMARY KEY clause determines partitioning criteria</li>
</ul>
</div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="partition-key" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/partition-key.svg" /></span></p></div>
</section>
<section class="slide" id="partition-storage">
<h2>Partition Storage</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="distributed-partitions" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/distributed-partitions.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Cassandra distributes partitions across nodes</li>
<li>WHERE on any field other than partition key would require a scan of all partitions on all nodes</li>
<li>Inefficient access pattern</li>
</ul>
</div>
</section>
<section class="slide" id="where-and-partition-keys">
<h2>WHERE and Partition Keys</h2>
<div class="ulist">
<ul>
<li>We can WHERE on a partition key value</li>
<li>Cassandra uses a hashing algorithm to quickly determine which node(s) contain the desired partition</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="query-partition-key" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/query-partition-key.svg" /></span></p></div>
</section>
<section class="slide" id="composite-partition-keys">
<h2>Composite Partition Keys</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="composite-partition-key" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-2/composite-partition-key.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> videos (
  name <span class="predefined-type">text</span>,
  runtime <span class="predefined-type">int</span>,
  <span class="predefined-type">year</span> <span class="predefined-type">int</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((name, <span class="predefined-type">year</span>))
);</code></pre>
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>Multiple columns may make up the partition key</li>
<li>Extra set of parenthesis required</li>
<li><p>
Further columns can follow<div class="ulist">
<ul>
<li>Determine clustering columns</li>
<li>Discussed later</li>
</ul>
</div></p></li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-3-challenge-2">
<h2>Exercise 3&#8212;&#8203;KillrVideo Challenge 2</h2>

</section>
<section class="slide" id="courses-DS220-data-modeling-data-modeling-wins-challenge-3">
<h2>KillrVideo Challenge 3</h2>
<div class="paragraph"><p><strong>Query videos by a given tag sorted by year</strong></p></div>
<div class="ulist">
<ul>
<li>Upserts</li>
<li>Clustering columns</li>
</ul>
</div>
</section>
<section class="slide" id="upserts">
<h2>Upserts</h2>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">INSERT</span> <span class="class">INTO</span> users (email, password, userid)
<span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">cassandra.rock.star@datastax.com</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">abc</span><span class="delimiter">'</span></span>, <span class="integer">42</span>);</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all" style="width:15%">
<colgroup>
<col style="width:33%" />
<col style="width:33%" />
<col style="width:33%" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">email</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">userid</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:cassandra.rock.star@datastax.com">cassandra.rock.star@datastax.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">abc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
</tr>
</tbody>
</table>
<div class="listingblock slide">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">INSERT</span> <span class="class">INTO</span> users (email, password, userid)
<span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">cassandra.rock.star@datastax.com</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">123</span><span class="delimiter">'</span></span>, <span class="integer">24</span>);</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all slide" style="width:15%">
<colgroup>
<col style="width:33%" />
<col style="width:33%" />
<col style="width:33%" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">email</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">userid</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:cassandra.rock.star@datastax.com">cassandra.rock.star@datastax.com</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">123</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
</tr>
</tbody>
</table>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>In this example, <code>email</code> is the primary key.</p></div>
<div class="paragraph"><p>Inserting a row with a matching key of an existing row simply updates the existing value(s). Cassandra does not read before writing for INSERTs and will overwrite/update non-key values.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> me_test (
  me_key <span class="predefined-type">int</span>,
  me_value <span class="predefined-type">text</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((me_key))
);

<span class="class">UPDATE</span> me_test
<span class="class">SET</span> me_value = <span class="string"><span class="delimiter">'</span><span class="content">I love upserts!</span><span class="delimiter">'</span></span>
<span class="keyword">WHERE</span> me_key = <span class="integer">42</span>;</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all slide" style="width:50%">
<colgroup>
<col style="width:50%" />
<col style="width:50%" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">me_key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">me_value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I love upserts!</p></td>
</tr>
</tbody>
</table>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Again, by default and for speed, Cassandra does not read before writing, so all UPDATEs simply insert. Notice inserted values here from both the SET and the WHERE clauses.</p></div>
<div class="paragraph"><p>We will later show you how to have Cassandra prevent upserts, but it is best you see how to properly use Cassandra to its full potential by structuring your applications to work with it gracefully.</p></div>
</div>
</div>
</section>
<section class="slide" id="muhahahahahaaaaa">
<h2>MUHAHAHAHAHAAAAA!!</h2>
<div class="paragraph"><p><span class="image"><img alt="scary-clown" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/scary-clown.jpg" /></span></p></div>
</section>
<section class="slide" id="clustering-columns">
<h2>Clustering Columns</h2>
<div class="ulist">
<ul>
<li>Come after partition key within PRIMARY KEY clause</li>
<li>Data displays the same as before</li>
</ul>
</div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="table" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/table.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> videos (
  id <span class="predefined-type">int</span>,
  name <span class="predefined-type">text</span>,
  runtime <span class="predefined-type">int</span>,
  <span class="predefined-type">year</span> <span class="predefined-type">int</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((<span class="predefined-type">year</span>), name)
);</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Clustering columns divide CQL rows between partitions</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="clustering-columns-division" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/clustering-columns-division.svg" /></span></p></div>
<div class="paragraph notes"><p>These partitions are called multi-row partitions. Notice that the clustering column value now makes part of each cell&#8217;s key.</p></div>
</section>
<section class="slide" id="side-by-side-comparison">
<h2>Side by Side Comparison</h2>
<div class="paragraph"><p><span class="image"><img alt="side-by-side" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/side-by-side.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>The structure on the left makes single-row partitions (one CQL row per partition). The right structure will store several CQL rows per partition, grouped by the video year.</li>
<li>The structure on the right embeds the video name with each column name in each cell&#8217;s key.</li>
<li>We built the right structure specifically to service querying on videos in a given year.</li>
<li>Single row partitions are sometimes called skinny whereas multi-row partitions are sometimes called wide.</li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide" id="clustering-column-ordering">
<h2>Clustering Column Ordering</h2>
<div class="ulist">
<ul>
<li>Clustering column values stored sorted</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="ascending-order" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/ascending-order.svg" /></span></p></div>
<div class="paragraph notes"><p>Note Cassandra also stores the sub-column names sorted as well. That is, <code>id</code> comes before <code>runtime</code> within Interstellar and within Mockingjay. In this case, it is similar to an ORDER BY name THEN BY column name.</p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Default is ascending but you can specify descending</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="descending-order" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/descending-order.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>WITH CLUSTERING ORDER BY</strong></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> videos (
  id <span class="predefined-type">int</span>,
  name <span class="predefined-type">text</span>,
  runtime <span class="predefined-type">int</span>,
  <span class="predefined-type">year</span> <span class="predefined-type">int</span>,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((<span class="predefined-type">year</span>), name)
) WITH CLUSTERING <span class="keyword">ORDER</span> <span class="keyword">BY</span> (name <span class="directive">DESC</span>);</code></pre>
</div>
</div>
<div class="paragraph notes"><p>WITH CLUSTERING ORDER BY controls the sort order for each clustering column. The default sort order is ASC but you can override it to DESC. If you have multiple clustering columns, you must specify the sort order for each one within a WITH CLUSTERING ORDER BY clause regardless of whether you change the sort order or not.</p></div>
</section>
<section class="slide" id="querying-clustering-columns">
<h2>Querying Clustering Columns</h2>
<div class="ulist">
<ul>
<li>You can query on clustering columns because lookup is fast</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> *
<span class="keyword">FROM</span> videos
<span class="keyword">WHERE</span> <span class="predefined-type">year</span> = <span class="integer">2014</span> <span class="keyword">AND</span> name = <span class="string"><span class="delimiter">'</span><span class="content">Mockingjay</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph"><p><span class="image"><img alt="clustering-column-partitions" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/clustering-column-partitions.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>You can query on clustering columns because lookup is fast</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> *
<span class="keyword">FROM</span> videos
<span class="keyword">WHERE</span> <span class="predefined-type">year</span> = <span class="integer">2014</span> <span class="keyword">AND</span> name = <span class="string"><span class="delimiter">'</span><span class="content">Mockingjay</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph"><p><span class="image"><img alt="select-mockingjay" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/select-mockingjay.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>You can also do a range query on clustering columns</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> *
<span class="keyword">FROM</span> videos
<span class="keyword">WHERE</span> <span class="predefined-type">year</span> = <span class="integer">2014</span> <span class="keyword">AND</span> name &gt;= <span class="string"><span class="delimiter">'</span><span class="content">Interstellar</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph"><p><span class="image"><img alt="clustering-column-partitions" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/clustering-column-partitions.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>You can also do a range query on clustering columns</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> *
<span class="keyword">FROM</span> videos
<span class="keyword">WHERE</span> <span class="predefined-type">year</span> = <span class="integer">2014</span> <span class="keyword">AND</span> name &gt;= <span class="string"><span class="delimiter">'</span><span class="content">Interstellar</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph"><p><span class="image"><img alt="select-greaterequal-interstellar" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-3/select-greaterequal-interstellar.svg" /></span></p></div>
<div class="paragraph notes"><p>You can perform range queries because Cassandra stores clustering column values in sorted order. To return a result set, Cassandra jumps to the target partition and begins a linear read at the requested value. Linear reads are fast.</p></div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-4-challenge-3">
<h2>Exercise 4&#8212;&#8203;KillrVideo Challenge 3</h2>

</section>
<section class="slide" id="courses-DS220-data-modeling-data-modeling-wins-challenge-4">
<h2>KillrVideo Challenge 4</h2>
<div class="paragraph"><p><strong>Store multiple tags and encoding information with videos</strong></p></div>
<div class="ulist">
<ul>
<li>Collections columns</li>
<li>User Defined Types (UDTs)</li>
</ul>
</div>
</section>
<section class="slide" id="truncate">
<h2>TRUNCATE</h2>
<div class="ulist">
<ul>
<li>Deletes all data from a table</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">TRUNCATE</span> table1;</code></pre>
</div>
</div>
</section>
<section class="slide" id="alter-table">
<h2>ALTER TABLE</h2>
<div class="ulist">
<ul>
<li><p>
Adding a column<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">ALTER</span> <span class="type">TABLE</span> table1 <span class="class">ADD</span> another_column <span class="predefined-type">text</span>;</code></pre>
</div>
</div></p></li>
<li><p>
Dropping a column<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">ALTER</span> <span class="type">TABLE</span> table1 <span class="class">DROP</span> another_column;</code></pre>
</div>
</div></p></li>
<li>Cannot alter PRIMARY KEY</li>
</ul>
</div>
</section>
<section class="slide" id="collection-columns">
<h2>Collection Columns</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="butterflies" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-4/butterflies.jpg" width="80%" /></span></p></div>
<div class="ulist">
<ul>
<li>Collection columns are multi-valued columns</li>
<li>Designed to store a small amount of data</li>
<li>Retrieved in its entirety</li>
<li>Cannot nest a collection inside another collection</li>
</ul>
</div>
<div class="ulist notes">
<ul>
<li><p>
Maximum number of elements in a collection is 64 thousands<div class="ulist">
<ul>
<li>In practice – dozens or hundreds</li>
</ul>
</div></p></li>
<li><p>
Maximum size of element values is 64 KB<div class="ulist">
<ul>
<li>In practice – much smaller</li>
</ul>
</div></p></li>
<li><p>
Collection columns cannot be part of a primary key<div class="ulist">
<ul>
<li>No collections in a partition key</li>
<li>No collections in clustering columns</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="collection-column-syntax">
<h2>Collection Column Syntax</h2>
<div class="paragraph"><p><strong>Set</strong></p></div>
<div class="ulist">
<ul>
<li>Typed collection of unique values</li>
<li>Ordered by values</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SET</span>&lt;<span class="predefined-type">TEXT</span>&gt;</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>List</strong></p></div>
<div class="ulist">
<ul>
<li>Type collection of non-unique values</li>
<li>Ordered by position</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql">LIST&lt;<span class="predefined-type">TEXT</span>&gt;</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Map</strong></p></div>
<div class="ulist">
<ul>
<li>Typed collection of key-value pairs</li>
<li>Ordered by unique keys</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql">MAP&lt;<span class="predefined-type">TEXT</span>,<span class="predefined-type">INT</span>&gt;</code></pre>
</div>
</div>
</section>
<section class="slide" id="udts">
<h2>UDTs</h2>
<div class="ulist">
<ul>
<li>User-defined types (UDTs) group related fields of information</li>
<li>Allows embedding more complex data within a single column</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> TYPE address (
  street <span class="predefined-type">text</span>,
  city <span class="predefined-type">text</span>,
  zip_code <span class="predefined-type">int</span>,
  phones <span class="class">set</span>&lt;<span class="predefined-type">text</span>&gt;
);

<span class="class">CREATE</span> TYPE full_name (
  first_name <span class="predefined-type">text</span>,
  last_name <span class="predefined-type">text</span>
);</code></pre>
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>UDT fields can be any data type, including collections and other UDTs. Cassandra supports tuples as well.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Using a UDT</strong></p></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="frozen" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-4/frozen.jpg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> users (
  id uuid,
  name frozen &lt;full_name&gt;,
  direct_reports <span class="class">set</span>&lt;frozen &lt;full_name&gt;&gt;,
  addresses map&lt;<span class="predefined-type">text</span>, frozen &lt;address&gt;&gt;,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((id))
);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>Add <code>frozen</code> keyword, but don&#8217;t stress its meaning for now</li>
<li>Just let it go, don&#8217;t hold it back anymore</li>
</ul>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-5-challenge-4">
<h2>Exercise 5&#8212;&#8203;KillrVideo Challenge 4</h2>

</section>
<section class="slide" id="courses-DS220-data-modeling-data-modeling-wins-challenge-5">
<h2>KillrVideo Challenge 5</h2>
<div class="paragraph"><p><strong>Allow queries for number of videos there are per tag</strong></p></div>
<div class="ulist">
<ul>
<li>COUNTER</li>
<li>SOURCE</li>
</ul>
</div>
</section>
<section class="slide" id="counters">
<h2>Counters</h2>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> moo_counts (
  cow_name <span class="predefined-type">text</span>,
  moo_count counter,
  <span class="directive">PRIMARY</span> <span class="type">KEY</span>((cow_name))
);

<span class="class">UPDATE</span> moo_counts
<span class="class">SET</span> moo_count = moo_count + <span class="integer">8</span>
<span class="keyword">WHERE</span> cow_name = <span class="string"><span class="delimiter">'</span><span class="content">Betsy</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Fundamentals:</p></div>
<div class="ulist">
<ul>
<li>Distributed</li>
<li>Can increment/decrement and read</li>
<li>Cannot INSERT or assign (default zero value)</li>
<li>Must be only non-primary key column</li>
<li>Can have multiple counter columns in one table</li>
</ul>
</div>
<div class="paragraph"><p>Performance considerations:</p></div>
<div class="ulist">
<ul>
<li>Read is as efficient as for non-counter columns</li>
<li>Update is fast but slightly slower than an update for non-counter columns</li>
<li>A read is required before a write</li>
</ul>
</div>
<div class="paragraph"><p>Accuracy considerations:</p></div>
<div class="ulist">
<ul>
<li>If a counter update times out, a client application cannot retry as the update may have been persisted (timeout is not necessarily an update failure).</li>
<li>Counter update is not an idempotent operation</li>
<li>Running an increment twice is not the same as running it once.</li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide" id="sourcing-files">
<h2>Sourcing Files</h2>
<div class="ulist">
<ul>
<li>Executes a file containing CQL statements</li>
<li>Enclose file name in single quotes</li>
<li>Output for each statement appears in turn</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql">SOURCE <span class="string"><span class="delimiter">'</span><span class="content">./myscript.cql</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-6-challenge-5">
<h2>Exercise 6&#8212;&#8203;KillrVideo Challenge 5</h2>

</section>
<section class="slide" id="courses-DS220-data-modeling-data-modeling-wins-challenge-6">
<h2>KillrVideo Challenge 6</h2>
<div class="paragraph"><p><strong>Query videos by actor or genre</strong></p></div>
<div class="ulist">
<ul>
<li>Denormalizing tables</li>
<li>Differing PRIMARY KEY structures</li>
</ul>
</div>
</section>
<section class="slide" id="typical-relational-table-structure">
<h2>Typical Relational Table Structure</h2>
<div class="paragraph"><p><span class="image"><img alt="challenge-6\relational-tables" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/relational-tables.svg" /></span></p></div>
<div class="paragraph notes"><p>Here we have some typical normalized relational table structures. In the relational database world we like this structure because updating requires writing to a single cell. Normalized tables also save disk space. Now suppose we want to query for comments in two ways: by video title and by user login.</p></div>
</section>
<section class="slide" id="query-comments-by-video-title">
<h2>Query Comments by Video Title</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="challenge-6\videos-comments-join" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/videos-comments-join.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> <span class="class">comment</span>
<span class="keyword">FROM</span> videos <span class="keyword">JOIN</span> comments
  <span class="keyword">ON</span> videos.id = comments.video_id
<span class="keyword">WHERE</span> title = <span class="string"><span class="delimiter">'</span><span class="content">Interstellar</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph notes"><p>As is typical, we join <strong>videos</strong> with comments to retrieve each <em>comment</em> for a given <em>title</em>. The database combines each matching pair from both tables based on <strong>video</strong> <em>id</em> and then linearly searches that result set where the <em>title</em> is Interstellar. That&#8217;s a lot of work given even a handful of videos.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="challenge-6\videos-comments-joined" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/videos-comments-joined.svg" /></span></p></div>
<div class="paragraph notes"><p>Notice the JOIN denormalizes the data.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="challenge-6\videos-comments-joined-search" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/videos-comments-joined-search.svg" /></span></p></div>
<div class="paragraph notes"><p>After the join, the database then searches based on the WHERE clause.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="\" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/videos-comments-final-result-set.svg" /></span></p></div>
</section>
<section class="slide" id="query-comments-by-user-login">
<h2>Query Comments by User Login</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="challenge-6\user-comments-join-1" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/user-comments-join-1.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> <span class="class">comment</span>
<span class="keyword">FROM</span> users <span class="keyword">JOIN</span> comments
  <span class="keyword">ON</span> users.id = comments.user_id
<span class="keyword">WHERE</span> user.login = <span class="string"><span class="delimiter">'</span><span class="content">emotions</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph notes"><p>Similar to the previous query, the database joins these two tables on matching criteria and then performs another linear search based on our WHERE condition. If we are lucky, the database may perform the linear search before joining, but such behaviour is not always guaranteed.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="challenge-6\user-comments-join-2" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/user-comments-join-2.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> <span class="class">comment</span>
<span class="keyword">FROM</span> users <span class="keyword">JOIN</span> comments
  <span class="keyword">ON</span> users.id = comments.user_id
<span class="keyword">WHERE</span> user.login = <span class="string"><span class="delimiter">'</span><span class="content">emotions</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph notes"><p>And if we have hundreds of thousands of users each making thousands of comments (because we are that awesome), this join could take a while&#8230;&#8203;</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="challenge-6\user-comments-join-3" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/user-comments-join-3.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">SELECT</span> <span class="class">comment</span>
<span class="keyword">FROM</span> users <span class="keyword">JOIN</span> comments
  <span class="keyword">ON</span> users.id = comments.user_id
<span class="keyword">WHERE</span> user.login = <span class="string"><span class="delimiter">'</span><span class="content">emotions</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph notes"><p>&#8230;&#8203;eons of time!</p></div>
</section>
<section class="slide" id="kill-me-now">
<h2>Kill Me Now!</h2>
<div class="paragraph"><p><span class="image"><img alt="challenge-6\frustrated-user" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/frustrated-user.jpg" /></span></p></div>
<div class="paragraph notes"><p>How long do you typically wait for a page refresh before you switch to doing something else? Yep, KillrVideo&#8217;s users have the same problem. Let&#8217;s not keep them waiting.</p></div>
</section>
<section class="slide" id="denormalizing-for-query-performance">
<h2>Denormalizing for Query Performance</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="challenge-6\denormalized-tables" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/denormalized-tables.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> comments_by_video (
        video_title <span class="predefined-type">text</span>,
        comment_id timeuuid,
        user_id <span class="predefined-type">text</span>,
        video_id timeuuid,
        <span class="class">comment</span> <span class="predefined-type">text</span>,
        <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((video_title), comment_id)
);

<span class="class">CREATE</span> <span class="type">TABLE</span> comments_by_user (
        user_login <span class="predefined-type">text</span>,
        comment_id timeuuid,
        user_id <span class="predefined-type">text</span>,
        video_id timeuuid,
        <span class="class">comment</span> <span class="predefined-type">text</span>,
        <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((user_login), comment_id)
);</code></pre>
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>We know users want to query for comments based on a <strong>video</strong> <em>title</em> or a <strong>user</strong>'s <em>login</em>, so in Cassandra we build partition structures to support these queries directly. The partition keys are <strong>video</strong> <em>title</em> for the first and <strong>user</strong> <em>login</em> for the second. Retrieving the appropriate partition is a matter of hashing the given WHERE value and then contacting the node storing that partition.</p></div>
<div class="paragraph"><p>Also notice that the JOIN operations earlier denormalized the data at query time. This is an expensive operation we pre-empt in Cassandra by storing our data denormalized to begin with. Both tables store copies of <strong>comment</strong> data.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="challenge 6\denormalized tables cql" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/denormalized-tables-cql.svg" />
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> comments_by_video (
        video_title <span class="predefined-type">text</span>,
        comment_id timeuuid,
        user_id <span class="predefined-type">text</span>,
        video_id timeuuid,
        <span class="class">comment</span> <span class="predefined-type">text</span>,
        <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((video_title), comment_id)
);

<span class="class">CREATE</span> <span class="type">TABLE</span> comments_by_user (
        user_login <span class="predefined-type">text</span>,
        comment_id timeuuid,
        user_id <span class="predefined-type">text</span>,
        video_id timeuuid,
        <span class="class">comment</span> <span class="predefined-type">text</span>,
        <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((user_login), comment_id)
);</code></pre>
</div>
</div>
<div class="paragraph notes"><p>Although Cassandra stores the data in partitions, CQL provides a convenient interface of querying table structures. Denormalize that data!</p></div>
</section>
<section class="slide" id="faster-performance-happy-users">
<h2>Faster Performance - Happy Users</h2>
<div class="paragraph"><p><span class="image"><img alt="challenge-6\happy-users" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-6/happy-users.jpg" /></span></p></div>
<div class="paragraph notes"><p>Faster queries means happier users. Perhaps this slide has a bit too much happiness, but you get the idea. (We had leftover stock images on our account, so we used them here. :)</p></div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-7-challenge-6">
<h2>Exercise 7&#8212;&#8203;KillrVideo Challenge 6</h2>

</section>
<section class="slide" id="courses-DS220-data-modeling-data-modeling-wins-challenge-final">
<h2>KillrVideo Final Challenge</h2>
<div class="paragraph"><p><strong>KillrVideo Roadmap</strong></p></div>
<div class="ulist">
<ul>
<li>New features need to be added to our existing domain</li>
</ul>
</div>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="killrvideo roadmap" src="images/courses/DS220/data-modeling/data-modeling-wins/challenge-final/killrvideo-roadmap.svg" />
</div>
</div>
<div class="paragraph notes"><p>The purpose of this roadmap is to illustrate the fact that just adding features on an as-needed basis doesn&#8217;t scale and is unsustainable.<br />
Knowing your data and your queries are the key to a good data model.</p></div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-8-final-challenge">
<h2>Exercise 8&#8212;&#8203;KillrVideo Final Challenge</h2>

</section>
<section class="slide transition-green" id="courses-DS220-transitions-conceptual-transition">
<h2>Conceptual Data Model</h2>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="conceptual trans" src="images/courses/DS220/transitions/conceptual-transition/conceptual-trans.svg" />
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-conceptual">
<h2>Conceptual Data Modeling</h2>
<div class="ulist">
<ul>
<li>Abstract view of the domain</li>
<li>Technology independent</li>
<li>Not specific to any database system</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="conceptual" src="images/cassandra/dev/data-modeling/conceptual/conceptual.svg" /></span></p></div>
<div class="paragraph notes"><p>Conceptual data models reflects the domain rather than how we store the domain data on disk. Once we complete our conceptual model, we map it to our target database storage strategy. With conceptual data modeling, we do not stress the technical details but instead address the question: what exactly do we want to store and how are they related?</p></div>
</section>
<section class="slide" id="chen-notation">
<h2>Chen Notation</h2>
<div class="paragraph"><p><span class="image"><img alt="Chen" src="images/cassandra/dev/data-modeling/conceptual/Chen.jpg" /></span></p></div>
</section>
<section class="slide" id="purpose">
<h2>Purpose</h2>
<div class="ulist">
<ul>
<li>Understand your data</li>
<li>Essential objects</li>
<li>Constraints</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="user_comment_video_rating" src="images/cassandra/dev/data-modeling/conceptual/user_comment_video_rating.svg" /></span></p></div>
<div class="paragraph notes"><p>Through conceptual modeling, we identify our entities, relationship, how they relate together. It helps us better understand our data (the domain).</p></div>
</section>
<section class="slide" id="advantages">
<h2>Advantages</h2>
<div class="paragraph"><p><strong>Collaboration</strong></p></div>
<div class="paragraph"><p><span class="image"><img alt="collaboration" src="images/cassandra/dev/data-modeling/conceptual/collaboration.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>As database architects, it is critical that our solutions directly serve our business&#8217;s needs. Often you will not be the expert on the business domain, and thus, must interact with non-technical people who are. Both technical and non-technical team members can share, review, and agree upon the conceptual data model. Business experts can then verify and feel comfortable that the conceptual model is correct. Everyone is on the same page. Everyone is happy.</p></div>
<div class="paragraph"><p>Collaboration between different technical roles is also critical. Cassandra requires database administrators and developers to work closer together. The conceptual model is a means of facilitating that communication.</p></div>
</div>
</div>
</section>
<section class="slide" id="abstraction">
<h2>Abstraction</h2>
<div class="paragraph"><p><span class="image"><img alt="mess" height="800" src="images/cassandra/dev/data-modeling/conceptual/mess.jpg" width="800" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="neat" height="800" src="images/cassandra/dev/data-modeling/conceptual/neat.jpg" width="800" /></span></p></div>
<div class="paragraph notes"><p>Abstraction help us manage complex models by hiding the details and allowing you to focus on the big picture. Taking the time to plan, design, and build your conceptual model will save time in the long run.</p></div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-conceptual-entity-relationship-model-fundamentals">
<h2>Entity-Relationship (ER) Model</h2>
<div class="paragraph"><p><strong>Entity Types - Relationship Types - Attribute Types</strong></p></div>
<div class="paragraph"><p><span class="image"><img alt="conceptual" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/conceptual.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Entity - object that is involved in an information system</p></div>
<div class="paragraph"><p>Entity type - set of similar objects</p></div>
<div class="paragraph"><p>Relationship - relates two or more entities</p></div>
<div class="paragraph"><p>Relationship type - set of similar relationships</p></div>
<div class="paragraph"><p>Attribute - descriptor of an entity/relationship</p></div>
<div class="paragraph"><p>Attribute type - set of similar attributes</p></div>
</div>
</div>
</section>
<section class="slide" id="entity-type">
<h2>Entity Type</h2>
<div class="paragraph"><p><span class="image"><img alt="entities" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/entities.svg" /></span></p></div>
<div class="ulist">
<ul>
<li class="slide">Represents objects in your domain</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Entity is the data modeling term for something you want to store in your database. Nicolas Cage and Interstellar are both entities (objects we are interested in recording information about).</p></div>
<div class="paragraph"><p>An entity type is an abstract notion of an entity. Here, <strong>Video</strong> is an entity type, whereas Interstellar, Mockingjay, and Curse of the Black Pearl are <strong>Video</strong> entities. <strong>Actor</strong> is also an entity type having Matthew McConaughey, Jennifer Lawrence, and Johnny Depp as entities.</p></div>
<div class="paragraph"><p><span class="image"><img alt="video-actor" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/video-actor.svg" /></span></p></div>
</div>
</div>
</section>
<section class="slide" id="relationship-type">
<h2>Relationship Type</h2>
<div class="paragraph"><p><span class="image"><img alt="relationships" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/relationships.svg" /></span></p></div>
<div class="ulist">
<ul>
<li class="slide">Represents relationships between two or more entities</li>
<li class="slide">Bi-directional name reading (optional)</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Interstellar features Matthew McConaughey is a relationship. Pirates of the Caribbean features Johnny Depp is a relationship. <strong>Video</strong> features <strong>Actor</strong> is a relationship type (set of similar relationships).</p></div>
<div class="paragraph"><p><span class="image"><img alt="video-actor-single" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/video-actor-single.svg" /></span></p></div>
<div class="paragraph"><p>Use the top name in the diamond when reading the relationship left to right. Use the bottom name when reading right to left. As diagrams grow with several entities and relationships, the layout may require reading the relationship in either direction.</p></div>
</div>
</div>
</section>
<section class="slide" id="cardinality">
<h2>Cardinality</h2>
<div class="paragraph"><p><span class="image"><img alt="cardinality" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/cardinality.svg" /></span></p></div>
<div class="ulist">
<ul>
<li class="slide">Number of times an entity can/must participate in the relationship</li>
<li class="slide"><p>
Other possibilities:<div class="ulist">
<ul>
<li>1-n</li>
<li>1-1</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="attribute-types">
<h2>Attribute Types</h2>
<div class="paragraph"><p><span class="image"><img alt="attributes" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/attributes.svg" /></span></p></div>
<div class="ulist">
<ul>
<li class="slide">Fields to store data about an entity or relationship</li>
</ul>
</div>
<div class="paragraph notes"><p>Attributes are fields we wish to record about our data. For example, we want to store the <em>title</em> and <em>description</em> of each <strong>Video</strong>.</p></div>
</section>
<section class="slide" id="key-attribute">
<h2>Key Attribute</h2>
<div class="paragraph"><p><span class="image"><img alt="key-attribute" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/key-attribute.svg" /></span></p></div>
<div class="ulist">
<ul>
<li class="slide">Identifies an object</li>
</ul>
</div>
</section>
<section class="slide" id="composite-attribute">
<h2>Composite Attribute</h2>
<div class="paragraph"><p><span class="image"><img alt="composite-attribute" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/composite-attribute.svg" /></span></p></div>
<div class="ulist">
<ul>
<li class="slide">Groups related attributes together</li>
</ul>
</div>
</section>
<section class="slide" id="multi-valued-attribute">
<h2>Multi-Valued Attribute</h2>
<div class="paragraph"><p><span class="image"><img alt="multi-valued-attributes" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/multi-valued-attributes.svg" /></span></p></div>
<div class="ulist">
<ul>
<li class="slide">Attribute stores multiple values per entity</li>
</ul>
</div>
<div class="paragraph notes"><p>Relational database architects often strive for first normal form (one value per attribute). Multi-valued attributes compromise by maintaining each value&#8217;s individuality within a single attribute. (Multi-valued attributes do not require parsing their entries into individual values from a string.)</p></div>
</section>
<section class="slide" id="weak-entity-types">
<h2>Weak Entity Types</h2>
<div class="ulist">
<ul>
<li>Cannot exist without an identifying relationship to a strong entity type</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="weak-entity" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/fundamentals/weak-entity.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Weak entity types are double outlined. We connect them to strong entity types using an identifying relationship (also double outlined).</p></div>
<div class="paragraph"><p>In this example, <strong>Encoding</strong> cannot exist without <strong>Video</strong>. Notice that <strong>Encoding</strong> does not have a key attribute. Instead, we identify <strong>Encoding</strong> using the key of its strong entity type (<strong>Video</strong>). If we remove <strong>Video</strong> from our model, then having <strong>Encoding</strong> makes no sense, and thus we must remove <strong>Encoding</strong> as well.</p></div>
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-conceptual-entity-relationship-model-keys">
<h2>Relationship Keys</h2>
<div class="paragraph"><p><span class="image"><img alt="intro" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/intro.svg" /></span></p></div>
<div class="paragraph notes"><p>As with entity types, relationship keys identify unique relationship instances. Unlike entity types, we do not explicitly underline relationship keys. Relationship keys depend on the participating entities, cardinality, and sometimes attributes. Think in terms of what uniquely identifies one relationship instance from another.</p></div>
</section>
<section class="slide" id="one-to-one-key">
<h2>One-to-One Key</h2>
<div class="ulist">
<ul>
<li>Use either of the participating entity keys</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="one-to-one" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/one-to-one.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Use either of the participating entity keys</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="one-to-one-movie-key" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/one-to-one-movie-key.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Use either of the participating entity keys</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="one-to-one-first-showing-key" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/one-to-one-first-showing-key.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Both <strong>Movie</strong> id and <strong>First Showing</strong> date and venue are unique in this relationship. Choose either as the relationship key.</p></div>
<div class="paragraph"><p>As always, it helps to consider concrete examples. <strong>Snow White and the Seven Dwarfs</strong> has a <strong>First Showing</strong> on December 21, 1937 at the Carthay Circle Theatre.</p></div>
</div>
</div>
</section>
<section class="slide" id="one-to-many-key">
<h2>One-to-Many Key</h2>
<div class="ulist">
<ul>
<li>Use the entity key sitting on the many relationship side</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="one-to-many" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/one-to-many.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Use the entity key sitting on the many relationship side</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="one-to-many-comment-key" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/one-to-many-comment-key.svg" /></span></p></div>
<div class="paragraph notes"><p><strong>Comment</strong> id will be unique for every pair of <strong>User</strong> and <strong>Comment</strong>.</p></div>
</section>
<section class="slide" id="many-to-many-key">
<h2>Many-to-Many Key</h2>
<div class="ulist">
<ul>
<li>Combine both entity keys</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="many-to-many" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/many-to-many.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Combine both entity keys</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="many-to-many-both" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/many-to-many-both.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>An <strong>Actor</strong> can appear in several <strong>Video</strong> objects. A <strong>Video</strong> can have several <strong>Actor</strong> objects. Neither key alone will be unique, so we must pair them to identify a relationship instance.</p></div>
</div>
</div>
</section>
<section class="slide" id="attribute-key-participation">
<h2>Attribute Key Participation</h2>
<div class="ulist">
<ul>
<li>Relationship attributes can make part of the key</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="keyed-attribute" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/keyed-attribute.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Relationship attributes can make part of the key</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="keyed-attribute-keys" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/keys/keyed-attribute-keys.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>When a relationship attribute is part of the key, both entities may participate multiple times given the attribute value(s) are unique. One example of this is Tom Hanks and Polar Express. Tom Hanks played most of the adult characters in Polar Express film such as the Train Conductor, Santa, Hobo, the Father, etc.</p></div>
<div class="paragraph"><p>You cannot explicitly diagram whether an attribute is part of the relationship key. You know by simply understanding your domain requirements.</p></div>
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-conceptual-entity-relationship-model-hierarchies">
<h2>Video Types</h2>
<div class="paragraph"><p><strong>What is a video?</strong></p></div>
<div class="ulist">
<ul>
<li>Video</li>
<li>Full Video</li>
<li>Trailer</li>
<li>TV Show</li>
<li>Movie</li>
<li>Anything else?</li>
</ul>
</div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="theater-tv-user-uploaded" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/hierarchies/theater-tv-user-uploaded.jpg" /></span></p></div>
<div class="paragraph notes"><p>When modelling our KillrVideo enterprise, we may recognize a number of video-related entity types, such as <em>Video</em>, <em>Full Video</em>, <em>Trailer</em>, <em>TV Show</em>, <em>Movie</em>, and so on.<br />
We should also notice that these entity types can be related to each other, such as <em>Full Video</em> and <em>Trailer</em> are <em>subtypes</em> of <em>Video</em>, and <em>TV Show</em> and <em>Movie</em> are <em>subtypes</em> of <em>Full Video</em>.<br />
This brings us to the notion of entity type hierarchy.</p></div>
</section>
<section class="slide" id="entity-type-hierarchy">
<h2>Entity Type Hierarchy</h2>
<div class="paragraph"><p><span class="image"><img alt="hierarchies\hierarchies-1" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/hierarchies/hierarchies-1.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>An entity type hierarchy is a classification hierarchy. The subtype constraints are captured with a special IsA relationship denoted with a triangle.</p></div>
<div class="paragraph"><p>In this example, we have a multi-level hierarchy and on each level we have a <em>supertype</em> and its <em>subtypes</em>. In particular, <em>Video</em> is supertype with subtypes <em>Full Video</em> and <em>Trailer</em>. Similarly, <em>Full Video</em> is a supertype with subtypes <em>TV Show</em> and <em>Movie</em>.</p></div>
<div class="paragraph"><p>Entity type hierarchies have two special properties, called <em>transitivity</em> and <em>inheritance</em>, and IsA relationships have two special constraints, called <em>covering constraint</em> and <em>disjointness constraint</em>.</p></div>
</div>
</div>
</section>
<section class="slide" id="transitivity">
<h2>Transitivity</h2>
<div class="paragraph"><p><span class="image"><img alt="hierarchies\hierarchies-2" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/hierarchies/hierarchies-2.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="hierarchies\hierarchies-3" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/hierarchies/hierarchies-3.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The subtype constraints and IsA relationships are <em>transitive</em>, meaning that if X is a subtype of Y and Y is a subtype of Z, then X is also a subtype of Z.</p></div>
<div class="paragraph"><p>Indeed, since <em>TV Show</em> is a subtype of <em>Full Video</em> and <em>Full Video</em> is a subtype of <em>Video</em>, we can conclude based on the transitivity property that <em>TV Show</em> is a subtype of <em>Video</em> as well. It will also be correct to say that <em>Video</em> has four subtypes in our classification hierarchy.</p></div>
</div>
</div>
</section>
<section class="slide" id="inheritance">
<h2>Inheritance</h2>
<div class="paragraph"><p><span class="image"><img alt="hierarchies\hierarchies-4" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/hierarchies/hierarchies-4.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Another important property of entity type hierarchies is <em>attribute inheritance</em>. Subtypes always inherit all attributes of supertypes, including key attributes. Inherited attributes are usually not shown on a diagram to eliminate redundancy and improve readability. For example, for this diagram, all <em>Video</em> subtypes inherit attributes <em>id</em>, <em>title</em>, <em>discription</em>, <em>tags</em>, and so forth. In addition, subtypes may have attributes of their own, which their corresponding supertypes may not have. This would be the case for attributes <em>season</em>, <em>episode</em>, and <em>MPAA rating</em> that describe <em>TV Show</em> and <em>Movie</em> respectively.</p></div>
</div>
</div>
</section>
<section class="slide" id="disjointness-constraint">
<h2>Disjointness Constraint</h2>
<div class="paragraph"><p><span class="image"><img alt="hierarchies\hierarchies-5" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/hierarchies/hierarchies-5.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The first important constraint for an IsA relationship is the disjointness constraint. By specifying that both of our IsA relationships are <em>disjoint</em>, we state that a video can be either a full video or a trailer but not both. Similarly, a full video can be either a TV show or a movie but not both. If we were to say that <em>TV Show</em> and <em>Movie</em> are not disjoint, that would mean that there can be a full video that is both a TV Show and a movie, which is not true for our <em>KillrVideo</em> domain.</p></div>
</div>
</div>
</section>
<section class="slide" id="covering-constraint">
<h2>Covering Constraint</h2>
<div class="paragraph"><p><span class="image"><img alt="hierarchies\hierarchies-6" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/hierarchies/hierarchies-6.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The second important constraint that we should always specify for every IsA relationship is the covering constraint. <em>Covering</em> means that a union of all entities that belong to entity types <em>Full Video</em> and <em>Trailer</em> equals to the set of entities of type <em>Video</em>. In other words, covering here would mean that <em>Full Video</em> and <em>Trailer</em> covers all of the possible roles for a video.</p></div>
<div class="paragraph"><p><em>Not covering</em> means that <em>TV Show</em> and <em>Movie</em> cover some of the possible roles for a full video, but not all of them. It is possible that there are other full video subtypes like <em>Interview</em>, <em>Webcast</em>, and so forth, which are not part of the diagram.</p></div>
<div class="paragraph"><p>It is worth mentioning that Cassandra database schema design will be affected by the properties and constraints we discussed. Indeed, a physical data model must reflect any constraints of a conceptual data model to be correct.</p></div>
</div>
</div>
</section>
<section class="slide" id="there-is-more-to-it-than-that">
<h2>There is More to It Than That &#8230;&#8203;</h2>
<div class="paragraph"><p><span class="image"><img alt="hierarchies\hierarchies-7" src="images/cassandra/dev/data-modeling/conceptual/entity-relationship-model/hierarchies/hierarchies-7.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Finally, you should remember that entity types, which are organized into classification hierarchies, are still entity types. They can participate in relationship types, such as <em>Full Video</em> may have many <em>Trailers</em> and <em>Trailer</em> is for one <em>Video</em>.</p></div>
</div>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-9-model-entities">
<h2>Exercise 9&#8212;&#8203;Modeling the KillrVideo Entities</h2>

</section>
<section class="slide" id="courses-DS220-data-modeling-final-killrvideo-model">
<h2>Final Conceptual Model</h2>
<div class="paragraph"><p><span class="image"><img alt="final-killrvideo-model\killrvideo-conceptual" src="images/courses/DS220/data-modeling/final-killrvideo-model/killrvideo-conceptual.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="final-killrvideo-model\killrvideo-conceptual-1" src="images/courses/DS220/data-modeling/final-killrvideo-model/killrvideo-conceptual-1.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="final-killrvideo-model\killrvideo-conceptual-2" src="images/courses/DS220/data-modeling/final-killrvideo-model/killrvideo-conceptual-2.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="final-killrvideo-model\killrvideo-conceptual-3" src="images/courses/DS220/data-modeling/final-killrvideo-model/killrvideo-conceptual-3.svg" /></span></p></div>
</section>
<section class="slide transition-green" id="courses-DS220-transitions-app-workflow-transition">
<h2>Application Workflow</h2>
<div class="imageblock">
<div class="content">
<img alt="app workflow trans" src="images/courses/DS220/transitions/app-workflow-transition/app-workflow-trans.svg" />
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-application-workflows-and-access-patterns">
<h2>Application Workflow Model</h2>
<div class="ulist">
<ul>
<li><p>
Each application has a workflow<div class="ulist">
<ul>
<li>Tasks and causal dependencies form a graph</li>
</ul>
</div></p></li>
<li><p>
Access patterns help determine how data is accessed<div class="ulist">
<ul>
<li>Know what queries you will run first</li>
</ul>
</div></p></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Task: Have a user login to a site</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="Q1Slide2" height="600" src="images/cassandra/dev/data-modeling/application-workflows-and-access-patterns/Q1Slide2.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>Data-driven application accesses a database</li>
<li>Query labels denote access patterns for task</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Task: Show videos that were most recently uploaded</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="Q2Slide3" height="600" src="images/cassandra/dev/data-modeling/application-workflows-and-access-patterns/Q2Slide3.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>As more queries are conceived, access paths emerge</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Task: Give me information about a particular user</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="Q3Slide4" height="600" src="images/cassandra/dev/data-modeling/application-workflows-and-access-patterns/Q3Slide4.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Task: Show videos that were uploaded by a particular user</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="Q4Slide5" height="600" src="images/cassandra/dev/data-modeling/application-workflows-and-access-patterns/Q4Slide5.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Task: Find a video that has a particular video id</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="Q5Slide6" height="600" src="images/cassandra/dev/data-modeling/application-workflows-and-access-patterns/Q5Slide6.svg" />
</div>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-10-app-workflow">
<h2>Exercise 10&#8212;&#8203;Application Workflow and Access Patterns</h2>

</section>
<section class="slide transition-green" id="courses-DS220-transitions-mapping-conceptual-transition">
<h2>Mapping Conceptual to Logical</h2>
<div class="imageblock center">
<div class="content">
<img alt="mapping trans2" src="images/courses/DS220/transitions/mapping-conceptual-transition/mapping-trans2.svg" />
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-logical-query-driven-methodology">
<h2>Data Modeling Methodology</h2>
<div class="paragraph"><p><strong>Process to design a logical model</strong></p></div>
<div class="ulist">
<ul>
<li>Uses a top-down approach</li>
<li>Can be algorithmically defined</li>
<li>Effective in the long run—vs. dark art</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="query driven methodology" src="images/cassandra/dev/data-modeling/logical/query-driven-methodology/query-driven-methodology.svg" />
</div>
</div>
</section>
<section class="slide" id="query-driven-data-modeling">
<h2>Query-Driven Data Modeling</h2>
<div class="paragraph"><p>&nbsp;</p></div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img alt="workflow" src="images/cassandra/dev/data-modeling/logical/query-driven-methodology/workflow.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>This methodology uses the conceptual data model, application workflow and access patterns as inputs to generate the logical data model.</p></div>
<div class="paragraph"><p>This is done using the methodology&#8217;s  mapping rules and patterns to guide schema design and to ensure that the resulting logical model is correct and works properly.</p></div>
<div class="paragraph"><p>This logical model is described using the Chebotko diagram notation.</p></div>
</div>
</div>
</section>
<section class="slide" id="logical-model">
<h2>Logical Model</h2>
<div class="paragraph"><p><strong>Chebotko Diagram</strong></p></div>
<div class="ulist">
<ul>
<li>Visual diagram for Cassandra tables and access patterns</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img alt="chebotko diagram" src="images/cassandra/dev/data-modeling/logical/query-driven-methodology/chebotko-diagram.svg" />
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-logical-chebotko-diagrams">
<h2>Chebotko Diagrams</h2>
<div class="ulist">
<ul>
<li>Graphical representation of Cassandra database schema design</li>
<li>Documents the logical and physical data model</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="chebotko diagram 1" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/chebotko-diagram-1.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Graphical representation of Cassandra database schema design</li>
<li>Documents the logical and physical data model</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="chebotko diagram 2" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/chebotko-diagram-2.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Graphical representation of Cassandra database schema design</li>
<li>Documents the logical and physical data model</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="chebotko diagram 3" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/chebotko-diagram-3.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Graphical representation of Cassandra database schema design</li>
<li>Documents the logical and physical data model</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="chebotko diagram 4" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/chebotko-diagram-4.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Graphical representation of Cassandra database schema design</li>
<li>Documents the logical and physical data model</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="chebotko diagram 5" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/chebotko-diagram-5.svg" />
</div>
</div>
</section>
<section class="slide" id="chebotko-diagram-notation">
<h2>Chebotko Diagram Notation</h2>
<div class="paragraph"><p><strong>Table representation</strong></p></div>
<div class="ulist">
<ul>
<li>Logical-level shows column names and properties</li>
<li>Physical-level also shows the column data type</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="table schema" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/table-schema.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Although the physical-level Chebotko diagram appears to only have some additional information, it actually reflects the later optimized database schema after performing the analysis and validation steps. It should have all the information needed to instantiate the table in CQL.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Access patterns</strong></p></div>
<div class="ulist">
<ul>
<li>Directed links and query label shows how tables are accessed</li>
<li>Similar to the application workflow, but now with our logical information</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="access patterns" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/access-patterns.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Logical UDT diagram</strong></p></div>
<div class="ulist">
<ul>
<li>Represents user defined types and tuples</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="logical udt diagrams" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/logical-udt-diagrams.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>At the logical level, the name of a UDT diagram is the column name&#8212;&#8203;including the column notation.</li>
<li>For tuples, field names are used at the logical level.</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Physical UDT diagram</strong></p></div>
<div class="ulist">
<ul>
<li>Represents user defined types and tuples</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="physical udt diagrams" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/physical-udt-diagrams.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>At the physical level, a name is given to a UDT or will default to <code>&lt;column_name&gt;_type</code>.</li>
<li>For tuples, field names are not kept at the physical level.</li>
<li>CQL types are only captured at the physical level.</li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide" id="example-chebotko-diagram">
<h2>Example Chebotko Diagram</h2>
<div class="imageblock">
<div class="content">
<img alt="complete chebotko" src="images/cassandra/dev/data-modeling/logical/chebotko-diagrams/complete-chebotko.svg" />
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-logical-principles">
<h2>Cassandra Data Modeling Principles</h2>
<div class="ulist">
<ul>
<li>Know your data</li>
<li>Know your queries</li>
<li>Nest data</li>
<li>Duplicate data</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The principles reflect the key takeaways from the data-modeling-wins vertex.<br />
These slides goes into these principles in more detail when transitioning from a conceptual model.</p></div>
<div class="paragraph"><p>Nesting and duplicating data is essentially data denormalization.</p></div>
</div>
</div>
</section>
<section class="slide" id="know-your-data">
<h2>Know Your Data</h2>
<div class="paragraph"><p><strong>Understanding the data is the key to successful design</strong></p></div>
<div class="ulist">
<ul>
<li>Data captured by conceptual data model</li>
<li>Define what is stored in database</li>
<li>Preserve properties so that data is organized correctly</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="er diagram" src="images/cassandra/dev/data-modeling/logical/principles/er-diagram.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Components of the conceptual data model includes:</p></div>
<div class="ulist">
<ul>
<li>Entities</li>
<li>Relationships</li>
<li>Attributes</li>
<li>Keys</li>
<li>Cardinality constraints</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Key constraints affect schema design</strong></p></div>
<div class="ulist">
<ul>
<li>Entity and relationship keys affect the table primary keys</li>
<li>Primary key uniquely identifies a row / entity / relationship</li>
<li>Composed of a key and possibly additional columns</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="primary key" src="images/cassandra/dev/data-modeling/logical/principles/primary-key.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Both tables can store the same data about videos but the data organization is different.</p></div>
<div class="paragraph"><p>The key of <code>video</code> is represented by column <code>video_id</code>.</p></div>
<div class="paragraph"><p>The primary key of <code>videos_by_user</code> includes additional columns besides <code>video_id</code>.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Cardinality constraints affect the key for relationships</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="cardinality constraints" src="images/cassandra/dev/data-modeling/logical/principles/cardinality-constraints.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>One-to-One relationship can use the key from either entity.</p></div>
<div class="paragraph"><p>Many-to-Many uses the key from both entities.</p></div>
<div class="paragraph"><p><code>uploads'</code> key (top): <code>User id</code>.</p></div>
<div class="paragraph"><p><code>comments on'</code> key (bottom): User <code>id</code> and Video <code>id</code>.</p></div>
</div>
</div>
</section>
<section class="slide" id="know-your-queries">
<h2>Know Your Queries</h2>
<div class="paragraph"><p><strong>Queries directly affect schema design</strong></p></div>
<div class="ulist">
<ul>
<li>Queries captured by application workflow model</li>
<li>Table schema design changes if queries change</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="application-workflow" src="images/cassandra/dev/data-modeling/logical/principles/application-workflow.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Schema design organizes data to efficiently run queries</strong></p></div>
<div class="ulist">
<ul>
<li>Partition per query&#8201;&#8212;&#8201;<strong>ideal</strong></li>
<li>Partition+ per query&#8201;&#8212;&#8201;<strong>acceptable</strong></li>
<li>Table scan&#8201;&#8212;&#8201;<strong>anti-pattern</strong></li>
<li>Multi-table&#8201;&#8212;&#8201;<strong>anti-pattern</strong></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Multiple queries can be executed in parallel, which makes partition per query the most efficient. However it is possible to design queries to execute serially, such as in the case of client-side joins. This is where a query will execute first, and then a subsequent query can be executed based on the previous result. This may not be as efficient even if retrieving only a single partition per query. Client-side joins may be discussed later in more detail.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Partition per query</strong></p></div>
<div class="ulist">
<ul>
<li>The most efficient access pattern</li>
<li>Query accesses only one partition to retrieve results</li>
<li>Partition can be single-row or multi-row</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="partition query" src="images/cassandra/dev/data-modeling/logical/principles/partition-query.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Examples:</p></div>
<div class="ulist">
<ul>
<li>Find information for a specified user&#8212;&#8203;retrieve one row / partition.</li>
<li>Find all comments for a specified user&#8212;&#8203;retrieve many rows in one partition.</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="icon-caution" title="Caution"></i>
</td>
<td class="content">
An extreme form of this is to model all data into as few partitions as possible, which may make them too large and have undesirable performance.
</td>
</tr>
</table>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Partition+ per query</strong></p></div>
<div class="ulist">
<ul>
<li>Less efficient access pattern but not necessarily bad</li>
<li>Query needs to access multiple partitions to retrieve results</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="multi partition query" src="images/cassandra/dev/data-modeling/logical/principles/multi-partition-query.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>An example would be "Find movies that match one of multiple genres".</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Table scan and Multi-table</strong></p></div>
<div class="ulist">
<ul>
<li>Least efficient type of query but may be needed in some cases</li>
<li>Query needs to access all partitions in a table(s) to retrieve results</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="table query" src="images/cassandra/dev/data-modeling/logical/principles/table-query.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>An example of a multi-table query would be "Retrieve all data in a database".</p></div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
This is a pattern you do not want to use frequently.
</td>
</tr>
</table>
</div>
<div class="paragraph"><p>You may know what you&#8217;re doing if you are actively minimizing data redundancy and performing relatively efficient, client-side joins.<br />
More information about this may be discussed later for data duplication factor and client side joins.</p></div>
</div>
</div>
</section>
<section class="slide" id="nest-data">
<h2>Nest Data</h2>
<div class="paragraph"><p><strong>Data nesting is the main data modeling technique</strong></p></div>
<div class="ulist">
<ul>
<li>Nesting organizes multiple entities into a single partition</li>
<li>Supports partition per query data access</li>
<li><p>
Three data nesting mechanisms<div class="ulist">
<ul>
<li>Clustering columns&#8212;&#8203;multi-row partitions</li>
<li>Collection columns</li>
<li>User-defined type columns</li>
</ul>
</div></p></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Clustering columns - primary data nesting mechanism</strong></p></div>
<div class="ulist">
<ul>
<li>Partition key identifies an entity that other entities will nest into</li>
<li>Values in a clustering column identify the nested entities</li>
<li>Multiple clustering columns implement multi-level nesting</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="nest data clustering" src="images/cassandra/dev/data-modeling/logical/principles/nest-data-clustering.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Table <code>videos</code> does not do data nesting.</p></div>
<div class="paragraph"><p>Table <code>actors_by_video</code> nests all videos that an actor was featured into a partition for that actor&#8212;&#8203;the partition is identified by <code>video_id</code>.</p></div>
<div class="paragraph"><p>The shaded region denotes nested data.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>User-defined type&#8212;&#8203;secondary data nesting mechanism</strong></p></div>
<div class="ulist">
<ul>
<li>Represents one-to-one relationship, but can use in conjunction with collections</li>
<li>Easier than working with multiple collection columns</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="nest data udt" src="images/cassandra/dev/data-modeling/logical/principles/nest-data-udt.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>`video_type is a user-defined type.</p></div>
<div class="paragraph"><p>Table <code>videos_by_user</code> nests all videos as a collection in the <code>videos</code> column with the <code>video_type</code> type.</p></div>
</div>
</div>
</section>
<section class="slide" id="duplicate-data">
<h2>Duplicate Data</h2>
<div class="paragraph"><p><strong>Better to duplicate than to join data</strong></p></div>
<div class="ulist">
<ul>
<li><p>
Partition per query and data nesting may result in data duplication<div class="ulist">
<ul>
<li>Query results are pre-computed and materialized</li>
<li>Data can be duplicated across tables, partitions, and / or rows</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="duplicate" src="images/cassandra/dev/data-modeling/logical/principles/duplicate.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Different "views" of the same data = different queries.</p></div>
<div class="paragraph"><p>Duplicating data in Cassandra across multiple tables, partitions, and rows is a common practice that is required to efficiently support different queries over the same data.</p></div>
<div class="paragraph"><p>In the Cassandra world, the trade-off between space efficiency and time efficiency is almost always in favor of the latter. Normalization is not a priority here.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Data duplication can scale, joins cannot</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="duplicate join" src="images/cassandra/dev/data-modeling/logical/principles/duplicate-join.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>With duplication, Cassandra essentially works as "join on write", needing to possibly write data to multiple tables. This contrasts with relational databases that normalizes data and "joins on read".</p></div>
<div class="paragraph"><p>Query: Find information about videos that includes a specified actor.</p></div>
<div class="paragraph"><p>Design on the left requires a join: If there are 10 videos with the same actor, table <code>videos</code> must be queried for 10 partitions, which may reside on 10 different nodes.</p></div>
<div class="paragraph"><p>Design on the right requires no join and accesses only one partition for that query.</p></div>
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-logical-mapping-rules">
<h2>Mapping Rules</h2>
<div class="paragraph"><p><strong>For the query-driven methodology</strong></p></div>
<div class="ulist">
<ul>
<li>Mapping rules ensure that a logical data model is correct</li>
<li>Each query has a corresponding table</li>
<li>Tables are designed to allow queries to execute properly</li>
<li>Tables return data in the correct order</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Mapping Rule 1: Entities and relationships</li>
<li>Mapping Rule 2: Equality search attributes</li>
<li>Mapping Rule 3: Inequality search attributes</li>
<li>Mapping Rule 4: Ordering attributes</li>
<li>Mapping Rule 5: Key attributes</li>
</ul>
</div>
</section>
<section class="slide" id="mr1-entities-and-relationships">
<h2>MR1: Entities And Relationships</h2>
<div class="ulist">
<ul>
<li>Entity and relationship types map to tables</li>
<li>Entities and relationships map to partitions or rows</li>
<li>Partition may have data about one or more entities and relationships</li>
<li>Attributes are represented by columns</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr1 1" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr1-1.svg" />
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Violating this rule means you may have an incomplete data model
</td>
</tr>
</table>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p><strong>Rationale</strong><br />
Data from the conceptual level must also be preserved at the logical level.<br />
The same data can be duplicated across multiple tables, partitions, or rows.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Entity and relationship types map to tables</li>
<li>Entities and relationships map to partitions or rows</li>
<li>Partition may have data about one or more entities and relationships</li>
<li>Attributes are represented by columns</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr1 2" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr1-2.svg" />
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Violating this rule means you may have an incomplete data model
</td>
</tr>
</table>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p><strong>Rationale</strong><br />
Data from the conceptual level must also be preserved at the logical level.<br />
The same data can be duplicated across multiple tables, partitions, or rows.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Entity and relationship types map to tables</li>
<li>Entities and relationships map to partitions or rows</li>
<li>Partition may have data about one or more entities and relationships</li>
<li>Attributes are represented by columns</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr1 3" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr1-3.svg" />
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Violating this rule means you may have an incomplete data model
</td>
</tr>
</table>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p><strong>Rationale</strong><br />
Data from the conceptual level must also be preserved at the logical level.<br />
The same data can be duplicated across multiple tables, partitions, or rows.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Entity and relationship types map to tables</li>
<li>Entities and relationships map to partitions or rows</li>
<li>Partition may have data about one or more entities and relationships</li>
<li>Attributes are represented by columns</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr1 4" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr1-4.svg" />
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Violating this rule means you may have an incomplete data model
</td>
</tr>
</table>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p><strong>Rationale</strong><br />
Data from the conceptual level must also be preserved at the logical level.<br />
The same data can be duplicated across multiple tables, partitions, or rows.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Entity and relationship types map to tables</li>
<li>Entities and relationships map to partitions or rows</li>
<li>Partition may have data about one or more entities and relationships</li>
<li>Attributes are represented by columns</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr1 5" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr1-5.svg" />
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Violating this rule means you may have an incomplete data model
</td>
</tr>
</table>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p><strong>Rationale</strong><br />
Data from the conceptual level must also be preserved at the logical level.<br />
The same data can also be duplicated across multiple tables, partitions, or rows.<br />
A partition may have data about one or more entities and relationships.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Relationship type example</strong></p></div>
<div class="ulist">
<ul>
<li>Each relationship becomes a row in the table</li>
<li>Relationship type attributes are represented by columns</li>
<li>Queries and relationship cardinality affects the design of the primary key</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr1 relationship" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr1-relationship.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Table <code>videos_by_user</code> supports queries on <code>user_id</code>, and optionally, <code>video_id</code>.<br />
Table <code>users_by_video</code> supports queries on <code>video_id</code>.</p></div>
</div>
</div>
</section>
<section class="slide" id="mr2-equality-search-attributes">
<h2>MR2: Equality Search Attributes</h2>
<div class="paragraph"><p><strong>Attributes to query on must be in the front of the primary key</strong></p></div>
<div class="ulist">
<ul>
<li>Primary key is an ordered set of columns, made up of partition key and clustering columns</li>
<li>A partition key is formed by one or more of the leading primary key columns</li>
<li>Supported queries must include all partition key columns in the query</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr2 1" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr2-1.svg" />
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Violating this rule means that you may not be able to query on a specific column
</td>
</tr>
</table>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p><strong>Rationale</strong><br />
Table can only be queried on columns that make up the front of a primary key, which must include all partition key columns.<br />
The table can also be queried on all of the primary key columns.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Entity type example</strong></p></div>
<div class="ulist">
<ul>
<li>Equality search attributes become initial columns of a primary key</li>
<li>Querying on: <code>title</code> and <code>type</code></li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr2 entity" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr2-entity.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>All tables support queried on <code>title</code> and <code>type</code>. However the ordering of the primary key columns can change what columns can be queried.<br />
In 'videos_by_title_type', <code>title</code> and <code>type</code> must both be queried since they make up the primary key.<br />
In <code>videos_by_title</code>, <code>title</code> is first and makes up the partition key, and can always be queried. <code>type</code> can only be queried if <code>title</code> is queried too.<br />
In <code>videos_by_type</code>, <code>type</code> is first and can always be queried, and <code>title</code> can only be queried in addition with <code>type</code>.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Relationship type example</strong></p></div>
<div class="ulist">
<ul>
<li>Equality search attributes become initial columns of a primary key</li>
<li>Querying on: <code>last name</code> and <code>first name</code></li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr2 relationship" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr2-relationship.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>All tables support querying on <code>last_name</code> and <code>first_name</code>.<br />
In addition, all tables support querying on <code>last_name</code> and <code>first_name</code> and <code>video_id</code>.<br />
<code>videos_by_user_2</code> can also query on just one column: <code>last_name</code>.</p></div>
</div>
</div>
</section>
<section class="slide" id="mr3-inequality-search-attributes">
<h2>MR3: Inequality Search Attributes</h2>
<div class="paragraph"><p><strong>Inequality search attributes become clustering columns</strong></p></div>
<div class="ulist">
<ul>
<li>Clustering columns follow partition key columns in a primary key</li>
<li>The column involved in an inequality search must come after columns in the primary key that are used in an equality search</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr3 1" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr3-1.svg" />
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Violating this rule means you may not be able to do a certain inequality search or range scan
</td>
</tr>
</table>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Partition key columns do not allow for inequality searches, although there is a token-based inequality search.<br />
However, results from a token-based query are not meaningful for the commonly used partitioners.<br />
For queries that require an inequality search but without an equality search, an arbitrary column or bucket can be created for use as a search predicate.</p></div>
<div class="paragraph"><p><strong>Rationale</strong><br />
Clustering columns support inequality (range) query.<br />
Only one clustering column can be used in an inequality predicate.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Entity type example</strong></p></div>
<div class="ulist">
<ul>
<li>Inequality search attributes become clustering columns</li>
<li>Querying on: <em> <code>last_name</code> = ? and <code>registration_date</code> &gt; ?</em></li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr3 entity" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr3-entity.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>In <code>users</code>, <code>registration_date</code> is a clustering column.<br />
The primary keys are formed by columns that are queried on, <code>last_name</code> (equality), and <code>registration_date</code> (inequality).<br />
The primary keys also include columns that correspond to the key attributes, <code>user_id</code>.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Relationship type example</strong></p></div>
<div class="ulist">
<ul>
<li>Inequality search attributes become clustering columns</li>
<li>Querying on: <em> <code>user_id</code> = ? and <code>uploaded_timestamp</code> &gt; ?</em></li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr3 relationship" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr3-relationship.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>In table <code>videos_by_user</code>, uploaded_timestamp is a clustering column.</p></div>
<div class="paragraph"><p>How is the primary key formed?<br />
* Equality search attributes<br />
* Inequality search attributes<br />
* Key attributes</p></div>
</div>
</div>
</section>
<section class="slide" id="mr4-ordering-attributes">
<h2>MR4: Ordering Attributes</h2>
<div class="paragraph"><p><strong>Ordering attributes map to clustering columns</strong></p></div>
<div class="ulist">
<ul>
<li>In each partition, CQL rows are ordered based on the clustering columns</li>
<li>Ascending or descending order</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr4 1" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr4-1.svg" />
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Violating this rule means the query may not return column values in the order you want
</td>
</tr>
</table>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Entity type example</strong></p></div>
<div class="ulist">
<ul>
<li>Ordering attributes become clustering columns</li>
<li>Querying on: <em> <code>last_name</code> = ? and <code>registration_date</code> &gt; ?</em></li>
<li>Ordering attributes: <em> <code>registration_date</code> (ASC)</em></li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr4 entity" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr4-entity.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>In both tables, <code>registration_date</code> is a clustering column. The tables maintain the DESC and ASC order, respectively, for the rows in each partition.<br />
Retrieving default ordering is efficient. It can also be reversed in a query, which is slightly less efficient.<br />
Setting CLUSTERING ORDER BY can order columns that wouldn&#8217;t be possible for a ORDER BY query, such as having <code>registration_date</code> DESC and <code>user_id</code> ASC.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Relationship type example</strong></p></div>
<div class="ulist">
<ul>
<li>Ordering attributes become clustering columns</li>
<li>Querying on: <em> <code>user_id</code> = ? and <code>uploaded_timestamp</code> &gt; ?</em></li>
<li>Ordering attributes: <em> <code>uploaded_timestamp</code> (DESC)</em></li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr4 relationship" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr4-relationship.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p><code>uploaded_timestamp</code> (DESC) and <code>video_id</code> (ASC) are clustering columns.</p></div>
<div class="paragraph"><p>How is the primary key formed?<br />
* Equality search attributes <code>user_id</code><br />
* Inequality search attributes <code>uploaded_timestamp</code><br />
* Ordering attributes <code>uploaded_timestamp</code>, <code>video_id</code><br />
* Key attributes <code>video_id</code></p></div>
</div>
</div>
</section>
<section class="slide" id="mr5-key-attributes">
<h2>MR5: Key Attributes</h2>
<div class="paragraph"><p><strong>Key attributes map to primary key columns</strong></p></div>
<div class="ulist">
<ul>
<li>Primary key must include the columns that represent key attributes</li>
<li>Position and order of such columns may vary</li>
<li>Primary key may have additional columns to support specific queries</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Violating this rule may result in upsert operations&#8212;&#8203;loss of data
</td>
</tr>
</table>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p><strong>Rationale</strong><br />
Entities and relationships are uniquely identified by key attribute values.<br />
Row in a table is uniquely identified by primary key column values.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Entity type example</strong></p></div>
<div class="ulist">
<ul>
<li>Entity type key attributes are included as primary key columns</li>
<li>Queries also affect primary key design</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr5 entity" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr5-entity.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Key attribute for entity type <code>User</code>: <code>id</code>.<br />
Tables <code>users</code> and <code>users_by_last_name</code> have the column <code>user_id</code> that correspond to the key attribute and are part of the primary key for these tables.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Relationship type example</strong></p></div>
<div class="ulist">
<ul>
<li>Relationship type key attributes are included as primary key columns</li>
<li>Queries affect primary key design</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mr5 relationship" src="images/cassandra/dev/data-modeling/logical/mapping-rules/mr5-relationship.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Key attribute for relationship <code>posts</code>: <code>id</code>.<br />
<code>id</code> represents a role of <code>Video</code> in a relationship; a video can only participate in the relationship one time.<br />
Tables <code>videos_by_user</code> and <code>users_by_video</code> have column <code>video_id</code> that corresponds to the key attribute and is part of the primary keys for these tables.</p></div>
</div>
</div>
</section>
<section class="slide" id="applying-mapping-rules">
<h2>Applying Mapping Rules</h2>
<div class="ulist">
<ul>
<li>Create a table schema from the conceptual data model and for each query</li>
<li>Apply the mapping rules in order</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="apply mp 1" src="images/cassandra/dev/data-modeling/logical/mapping-rules/apply-mp-1.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Create a table schema from the conceptual data model and for each query</li>
<li>Apply the mapping rules in order&#8212;&#8203;MR1</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="apply mp 2" src="images/cassandra/dev/data-modeling/logical/mapping-rules/apply-mp-2.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Create a table schema from the conceptual data model and for each query</li>
<li>Apply the mapping rules in order&#8212;&#8203;MR1&#8212;&#8203;MR2</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="apply mp 3" src="images/cassandra/dev/data-modeling/logical/mapping-rules/apply-mp-3.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Create a table schema from the conceptual data model and for each query</li>
<li>Apply the mapping rules in order&#8212;&#8203;MR1&#8212;&#8203;MR2&#8212;&#8203;MR3</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="apply mp 4" src="images/cassandra/dev/data-modeling/logical/mapping-rules/apply-mp-4.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Create a table schema from the conceptual data model and for each query</li>
<li>Apply the mapping rules in order&#8212;&#8203;MR1&#8212;&#8203;MR2&#8212;&#8203;MR3&#8212;&#8203;MR4</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="apply mp 5" src="images/cassandra/dev/data-modeling/logical/mapping-rules/apply-mp-5.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Create a table schema from the conceptual data model and for each query</li>
<li>Apply the mapping rules in order&#8212;&#8203;MR1&#8212;&#8203;MR2&#8212;&#8203;MR3&#8212;&#8203;MR4&#8212;&#8203;MR5</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="apply mp 6" src="images/cassandra/dev/data-modeling/logical/mapping-rules/apply-mp-6.svg" />
</div>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-11-mapping-rules">
<h2>Exercise 11&#8212;&#8203;Extend the KillrVideo Logical Model</h2>

</section>
<section class="slide" id="cassandra-dev-data-modeling-logical-mapping-patterns">
<h2>Mapping Patterns</h2>
<div class="ulist">
<ul>
<li>Semi-formal definitions for common mapping use cases</li>
<li>Provides a graphical reference for designing a logical model</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns 1" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-1.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>Only covers use cases that nest data with the clustering column mechanism.</li>
<li>Ordering of the results is not taken into consideration.</li>
<li>These limitations mean that mapping patterns complement modeling principles and mapping rules, but doesn&#8217;t replace them.</li>
<li>Still need to consider modeling principles and mapping rules.</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Semi-formal definitions for common mapping use cases</li>
<li>Provides a graphical reference for designing a logical model</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns 2" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-2.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>Only covers use cases that nest data with the clustering column mechanism.</li>
<li>Ordering of the results is not taken into consideration.</li>
<li>These limitations mean that mapping patterns complement modeling principles and mapping rules, but doesn&#8217;t replace them.</li>
<li>Still need to consider modeling principles and mapping rules.</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Semi-formal definitions for common mapping use cases</li>
<li>Provides a graphical reference for designing a logical model</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns 3" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-3.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>Only covers use cases that nest data with the clustering column mechanism.</li>
<li>Ordering of the results is not taken into consideration.</li>
<li>These limitations mean that mapping patterns complement modeling principles and mapping rules, but doesn&#8217;t replace them.</li>
<li>Still need to consider modeling principles and mapping rules.</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Semi-formal definitions for common mapping use cases</li>
<li>Provides a graphical reference for designing a logical model</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns 4" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-4.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>Only covers use cases that nest data with the clustering column mechanism.</li>
<li>Ordering of the results is not taken into consideration.</li>
<li>These limitations mean that mapping patterns complement modeling principles and mapping rules, but doesn&#8217;t replace them.</li>
<li>Still need to consider modeling principles and mapping rules.</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Helps guide schema design</strong></p></div>
<div class="ulist">
<ul>
<li>Based on mapping rules and modeling principles for correctness and efficiency</li>
<li>Enables automation of a schema design</li>
<li>For each query, find an applicable mapping pattern and apply it</li>
</ul>
</div>
</section>
<section class="slide" id="query-driven-methodology-mapping-patterns">
<h2>Query-Driven Methodology Mapping Patterns</h2>
<div class="paragraph"><p><strong>Nine different patterns to use, depending on query requirements</strong></p></div>
<div class="ulist">
<ul>
<li>(2) Entity mapping patterns</li>
<li>(2) 1:1 relationship mapping patterns</li>
<li>(2) 1:n relationship mapping patterns</li>
<li>(2) m:n relationship mapping patterns</li>
<li>(1) Hierarchical mapping pattern</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<table class="tableblock frame-all grid-all" style="width:100%">
<colgroup>
<col style="width:33%" />
<col style="width:33%" />
<col style="width:33%" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mapping Pattern</th>
<th class="tableblock halign-left valign-top">Data Nesting</th>
<th class="tableblock halign-left valign-top">Duplication</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity and 1:1 relationship&#8212;&#8203;partitioned by key attributes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maybe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity and 1:1 relationship&#8212;&#8203;partitioned by non-key attributes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maybe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maybe</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1:n relationship</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maybe</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m:n relationship</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hierarchical</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
</tbody>
</table>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Entities and 1:1 relationships partitioned by key attributes may have data nesting if there are multiple key attributes.<br />
Entities and 1:1 relationships partitioned by non-key attributes will only have duplicated data if querying on a set-valued attribute, which essentially would be converted to a 1:n or m:n relationship.<br />
1:n relationships may have data duplication if querying on entity on the right.<br />
m:n relationships patterns potentially the most expensive data duplication</p></div>
</div>
</div>
</section>
<section class="slide" id="entity-mapping-patterns">
<h2>Entity Mapping Patterns</h2>
<div class="paragraph"><p><strong>Query attributes = key attributes</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns entity 1" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-entity-1.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>A slightly different entity called <code>Movie</code> is used for this example, where <code>title</code> and <code>release year</code> make up the key attributes for the entity <code>Movie</code>.</p></div>
<div class="paragraph"><p>Key attributes are in blue, regular attributes are in green.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Query attributes != key attributes</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns entity 2" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-entity-2.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>A slightly different entity called <code>Movie</code> is used for this example, where <code>title</code> and <code>release year</code> make up the key attributes for the entity <code>Movie</code>.</p></div>
<div class="paragraph"><p>Key attributes are in blue, regular attributes are in green.</p></div>
</div>
</div>
</section>
<section class="slide" id="relationship-mapping-patterns">
<h2>Relationship Mapping Patterns</h2>
<div class="paragraph"><p><strong>Design a table for a query accessing a relationship of multiple entities</strong></p></div>
<div class="ulist">
<ul>
<li><p>
Mapping patterns vary depending on the relationship cardinality<div class="ulist">
<ul>
<li>1:1 relationship</li>
<li>1:n relationship</li>
<li>m:n relationship</li>
</ul>
</div></p></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>1:1 relationship mapping patterns</strong></p></div>
<div class="ulist">
<ul>
<li>1:1 relationship mapping is similar to entity mapping</li>
<li>Relationship entities can be merged together into one entity</li>
<li>The key attributes can be derived from either one of the entities</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns rel 1 1" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-rel-1-1.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>In this 1:1 relationship, attributes from both entities were merged together, and the key attributes from <code>Movie</code> was arbitrarily chosen to be used for the merged entity <code>Movie - First Showing</code>.</p></div>
<div class="paragraph"><p>For the <code>Movie</code> and <code>Movie - First Showing</code> entity, key attributes are in blue and regular attributes are in green.<br />
For the <code>First Showing</code> entity, key attribute are in red and regular attributes are in orange.</p></div>
</div>
</div>
</section>
<section class="slide" id="1-n-relationship-mapping-patterns">
<h2>1:n Relationship Mapping Patterns</h2>
<div class="paragraph"><p><strong>Query attributes = key attributes</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns rel 1 n 1" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-rel-1-n-1.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Primary key: All query attributes, followed by all key attributes of <code>User uploads Video</code>.<br />
Static columns: Non-key attributes of <code>User</code>, if and only if all key attributes of <code>User</code> are part of the partition key.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Query attributes != key attributes</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns rel 1 n 2" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-rel-1-n-2.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Primary key: All query attributes, followed by all key attributes of <code>User uploads Video</code>.<br />
Additional <code>User</code> attributes can be added to the table at the cost of duplicating them for every video.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>n:1 relationship is the reverse direction of 1:n relationship</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns rel n 1" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-rel-n-1.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Mapping is similar to a 1:1 relationship with data duplication</li>
<li>Data nesting only if the table is partitioned by non-key attributes</li>
<li>Attributes for the entity on the right will be duplicated</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>For the <code>Video</code> entity, key attributes are in blue and regular attributes are in green.<br />
For the <code>User</code> entity, key attribute are in red and regular attributes are in orange.<br />
Attributes for the relationship <code>is uploaded by</code> is in white.</p></div>
</div>
</div>
</section>
<section class="slide" id="m-n-relationship-mapping-patterns">
<h2>m:n Relationship Mapping Patterns</h2>
<div class="paragraph"><p><strong>Query attributes = key attributes</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns rel m n 1" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-rel-m-n-1.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Primary key: All query attributes, followed by all key attributes of <code>Video features Actor</code>.<br />
Static columns: Non-key attributes of <code>Video</code>, if and only if all key attributes of <code>Video</code> are part of the partition key.<br />
Columns <code>title</code> and <code>description</code> are not included in the table to the right due to unwanted duplication.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Query attributes != key attributes</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns rel m n 2" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-rel-m-n-2.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Primary key: All query attributes, followed by all key attributes of <code>Video features Actor</code>.<br />
Potentially expensive data duplication.</p></div>
</div>
</div>
</section>
<section class="slide" id="hierarchical-mapping-patterns">
<h2>Hierarchical Mapping Patterns</h2>
<div class="paragraph"><p><strong>Three approaches to designing hierarchies</strong></p></div>
<div class="ulist">
<ul>
<li>Creates one table as a supertype for hierarchies</li>
<li>Simplest to use with both covering and not covering constraints</li>
<li>Separate table for each type (not discussed here)</li>
<li>Table per subtype (not discussed here)</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Not only is there no duplication, but there is also no wasted space due to Cassandra&#8217;s storage model.<br />
Other databases may still allocate disk space even if columns do not have values.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Disjoint</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns hierarchical disjoint" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-hierarchical-disjoint.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The <code>type</code> column is used to specify the video&#8217;s type, and can be <code>TV Show</code>, <code>Movie</code>, or something else.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Not Disjoint</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="mapping patterns hierarchical not disjoint" src="images/cassandra/dev/data-modeling/logical/mapping-patterns/mapping-patterns-hierarchical-not-disjoint.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p><code>type</code> is now a set column so that multiple types can be assigned to a video.</p></div>
</div>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-12-mapping-patterns">
<h2>Exercise 12&#8212;&#8203;Map additional requirements for KillrVideo</h2>

</section>
<section class="slide transition-green" id="courses-DS220-transitions-physical-transition">
<h2>Physical Data Model</h2>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="physical trans" src="images/courses/DS220/transitions/physical-transition/physical-trans.svg" />
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-analysis-validation">
<h2>Let&#8217;s get physical!</h2>
<div class="paragraph"><p><span class="image"><img alt="physical" src="images/cassandra/dev/data-modeling/physical/analysis-validation/physical.jpg" /></span></p></div>
<div class="paragraph notes"><p>Just in case you haven&#8217;t had your dose of angry bros working out today&#8230;&#8203;</p></div>
</section>
<section class="slide" id="physical-data-modeling">
<h2>Physical Data Modeling</h2>
<div class="ulist">
<ul>
<li>Analysis and validation&#8212;&#8203;finding the problems</li>
<li>Physical optimization&#8212;&#8203;fixing the problems</li>
<li>Adding data types&#8212;&#8203;finalizing the model</li>
<li>CQL CREATE TABLE&#8212;&#8203;creating the tables</li>
</ul>
</div>
<div class="paragraph notes"><p>We add data types to each column of our logical model. We also optimize for efficiency and performance, ensuring our partition sizes won&#8217;t grow too large, our queries return quickly, etc. We then create our tables using CQL CREATE TABLE statements.</p></div>
</section>
<section class="slide" id="why-you-need-analysis">
<h2>Why You Need Analysis</h2>
<div class="paragraph"><p><strong>Finding the problem</strong></p></div>
<div class="ulist">
<ul>
<li>The Query-driven Methodology <em>should</em> result in a logical data model that is correct and works</li>
<li>Depends on the modeling principles, mapping rules, and mapping patterns being applied correctly</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="analysis validation" src="images/cassandra/dev/data-modeling/physical/analysis-validation/analysis-validation.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li><p>
Theoretically, the logical design should have efficient performance with best practices:<div class="ulist">
<ul>
<li>Partition per query</li>
<li>Nesting data</li>
<li>Duplicating data</li>
</ul>
</div></p></li>
<li><p>
In reality, the overall efficiency of the logical model is still up in the air<div class="ulist">
<ul>
<li>Database engine has limitations</li>
<li>Cluster resources: nodes, disk space, and memory, are finite</li>
<li>Operations that are not directly supported by Cassandra are inefficient by design</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Cassandra intentionally disallows operations that are inefficient for distributed systems or for Cassandra&#8217;s storage engine.</p></div>
<div class="paragraph"><p>However unsupported functionality may be required for particular queries, and need relatively inefficient workarounds to implement.</p></div>
</div>
</div>
</section>
<section class="slide" id="what-to-analyze">
<h2>What To Analyze</h2>
<div class="paragraph"><p><strong>Finding the problem</strong></p></div>
<div class="ulist">
<ul>
<li>Partition size</li>
<li>Data redundancy</li>
<li>Data consistency</li>
<li>Application-side joins</li>
<li>Referential integrity constraints</li>
<li>Transactions</li>
<li>Data aggregation</li>
</ul>
</div>
</section>
<section class="slide" id="optimizing-the-model">
<h2>Optimizing the Model</h2>
<div class="paragraph"><p><strong>Fixing the problem</strong></p></div>
<div class="ulist">
<ul>
<li>Key optimizations</li>
<li>Table optimizations</li>
<li>Concurrent access to data</li>
</ul>
</div>
</section>
<section class="slide" id="designing-the-model">
<h2>Designing the Model</h2>
<div class="paragraph"><p><strong>Finalizing the physical model</strong></p></div>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="physical table example" src="images/cassandra/dev/data-modeling/physical/analysis-validation/physical-table-example.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>This is an example logical to physical table example that you can use as a guideline to fill out remaining tables.</p></div>
</div>
</div>
</section>
<section class="slide" id="creating-the-tables">
<h2>Creating the Tables</h2>
<div class="paragraph"><p><strong>Writing the CQL statements</strong></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code>CREATE TABLE comments_by_user (
	user_id UUID,
	posted_timestamp TIMESTAMP,
	video_id TIMEUUID,
	comment TEXT,
	title TEXT,
	type TEXT,
	tags SET&lt;TEXT&gt;,
	preview_thumbnails MAP&lt;INT, BLOB&gt;,
	PRIMARY KEY ((user_id), posted_timestamp, video_id)
) WITH CLUSTERING ORDER BY (posted_timestamp DESC, video_id ASC);</code></pre>
</div>
</div>
</section>
<section class="slide transition-green" id="courses-DS220-transitions-analysis-finding-problem">
<h2>Analysis&#8212;&#8203;Finding the Problems</h2>

</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-analysis-validation-partition-size">
<h2>Partition Size Considerations</h2>
<div class="paragraph"><p><strong>Implementation limit on the size of a partition in Cassandra</strong></p></div>
<div class="ulist">
<ul>
<li>Number of values in a partition&#8201;&#8212;&#8201;2 billion</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="partition size" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/partition-size.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Size of the partition on disk&#8201;&#8212;&#8201;must be able to fit entirely on a node</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Number of values in a partitions is <strong>not the same</strong> as number of rows.<br />
Since a partition can store multiple CQL rows, the values in each row contribute to the total number of values in a partition.</p></div>
</div>
</div>
</section>
<section class="slide" id="recommendations-for-partition-size-and-number-of-values">
<h2>Recommendations For Partition Size and Number of Values</h2>
<div class="ulist">
<ul>
<li><p>
Cassandra 2.0 and earlier<div class="ulist">
<ul>
<li>Size: About 100 MB or less</li>
<li>Number of values: 100,000</li>
</ul>
</div></p></li>
<li><p>
Cassandra 2.1+<div class="ulist">
<ul>
<li>100&#8217;s of MB per partition</li>
<li>Number of values: Hundreds of thousands</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Other sources may say that the number of values in a partition has a practical limit. However, that would still typically be a result of the size of the partition. It is possible to go beyond 100K+ values in a partition with no degradation in performance.</p></div>
</div>
</div>
</section>
<section class="slide" id="calculating-number-of-values">
<h2>Calculating Number Of Values</h2>
<div class="paragraph"><p><strong>An estimate can be obtained using the following formula</strong></p></div>
<div class="ulist">
<ul>
<li>General formula</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="formula number values 1" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-number-values-1.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>If the table only has a primary key and static columns</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="formula number values 2" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-number-values-2.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>Nv = number of values</li>
<li>Nr = number of CQL rows</li>
<li>Nc = number of columns in the table</li>
<li>Npk = number of primary key columns</li>
<li>Ns = number of static columns</li>
</ul>
</div>
<div class="paragraph"><p></p></div>
<div class="ulist">
<ul>
<li>This formula provides only an estimate</li>
<li>Not all rows may have values for its columns</li>
<li>The number of values used in collection columns are not accounted for</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: Comments by User&#8201;&#8212;&#8201;Average case</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>An average user posts 100 comments</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="formula number values 3" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-number-values-3.svg" width="800" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The <code>comments_by_user</code> table in this example is slightly different from the normal model, since it is missing the <code>tags</code> and <code>type</code> columns and has a static column <code>user_email</code>.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: Comments by User&#8201;&#8212;&#8201;Average case</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>An average user posts 100 comments</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="formula number values row" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-number-values-row.svg" width="800" />
</div>
</div>
<div class="ulist">
<ul>
<li>100</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The <code>comments_by_user</code> table in this example is slightly different from the normal model, since it is missing the <code>tags</code> and <code>type</code> columns and has a static column <code>user_email</code>.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: Comments by User&#8201;&#8212;&#8201;Average case</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user all" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-all.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>An average user posts 100 comments</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="formula number values columns" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-number-values-columns.svg" width="800" />
</div>
</div>
<div class="ulist">
<ul>
<li>100 * (7</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The <code>comments_by_user</code> table in this example is slightly different from the normal model, since it is missing the <code>tags</code> and <code>type</code> columns and has a static column <code>user_email</code>.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: Comments by User&#8201;&#8212;&#8201;Average case</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user pk" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-pk.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>An average user posts 100 comments</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="formula number values pk" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-number-values-pk.svg" width="800" />
</div>
</div>
<div class="ulist">
<ul>
<li>100 * (7 - 3</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The <code>comments_by_user</code> table in this example is slightly different from the normal model, since it is missing the <code>tags</code> and <code>type</code> columns and has a static column <code>user_email</code>.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: Comments by User&#8201;&#8212;&#8201;Average case</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user static" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-static.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>An average user posts 100 comments</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="formula number values static" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-number-values-static.svg" width="800" />
</div>
</div>
<div class="ulist">
<ul>
<li>100 * (7 - 3 - 1) + 1</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The <code>comments_by_user</code> table in this example is slightly different from the normal model, since it is missing the <code>tags</code> and <code>type</code> columns and has a static column <code>user_email</code>.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: Comments by User&#8201;&#8212;&#8201;Average case</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>An average user posts 100 comments</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="formula number values 3" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-number-values-3.svg" width="800" />
</div>
</div>
<div class="ulist">
<ul>
<li>100 * (7 - 3 - 1) + 1  = <strong>301</strong></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The <code>comments_by_user</code> table in this example is slightly different from the normal model, since it is missing the <code>tags</code> and <code>type</code> columns and has a static column <code>user_email</code>.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: Comments by User&#8201;&#8212;&#8201;Bad case</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>A very active user posts 5,000 comments</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="formula number values 3" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-number-values-3.svg" width="800" />
</div>
</div>
<div class="ulist">
<ul>
<li>5000 * (7 - 3 - 1) + 1 = <strong>15,001</strong></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: Comments by User&#8201;&#8212;&#8201;Worst case</strong></p></div>
<div class="ulist">
<ul>
<li>What if a bot creates a user and posts 5,000 comments <strong>per second</strong>?</li>
</ul>
</div>
<div class="ulist">
<ul>
<li class="slide">15,001 values per second * 3,600 seconds = 54,003,600 comments per hour</li>
</ul>
</div>
<div class="ulist">
<ul>
<li class="slide">Less than 2 days to reach the 2 billion values limit!!</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: An extreme case</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="views by video" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/views-by-video.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>KillrVideo&#8217;s most popular video has over 2 billion views</li>
<li>The number of views definitely exceeds the partition limit</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: An extreme case</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="views by video" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/views-by-video.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>KillrVideo&#8217;s most popular video has over 2 billion views</li>
<li>The number of views definitely exceeds the partition limit</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="gangnam" height="400" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/gangnam.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Workarounds</strong></p></div>
<div class="ulist">
<ul>
<li><p>
Modify the use case<div class="ulist">
<ul>
<li>Store only the number of views as a single column</li>
<li>Store the number of views for each browser&#8201;&#8212;&#8201;one value per user agent</li>
</ul>
</div></p></li>
<li>Split the partition into multiple partitions&#8201;&#8212;&#8201;discussed elsewhere</li>
</ul>
</div>
</section>
<section class="slide" id="calculating-partition-size-on-disk">
<h2>Calculating Partition Size On Disk</h2>
<div class="paragraph"><p><strong>An estimate can be obtained using the following formula:</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="formula partition size" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-partition-size.svg" />
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
This formula only provides an estimate for data forecasting and analysis
</td>
</tr>
</table>
</div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li>cki = disk size of all partition key columns</li>
<li>csj = disk size of all static columns</li>
<li>Nr = number of CQL rows</li>
<li>crk = disk size of all regular columns</li>
<li>ccl = disk size of all clustering columns</li>
<li>8 bytes represents the internal written timestamp for each value</li>
<li>Nv = number of values in the partition</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>A CQL row may not necessary have values for all of its columns</li>
<li>Different values of the same type may have different sizes (e.g. text)</li>
<li>The formula does not account for partition metadata and the variable size of collection columns</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example: Comments by User</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user physical" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-physical.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>User posts 100 comments</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<table class="tableblock frame-all grid-all" style="width:100%">
<colgroup>
<col style="width:50%" />
<col style="width:50%" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column Name</th>
<th class="tableblock halign-left valign-top">Size</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">user_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post_timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">video_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16 bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">user_email</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30 bytes (average)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">video_title</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60 bytes (average)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">preview_thumbnails</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32,768 bytes (average)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">comment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300 bytes (average)</p></td>
</tr>
</tbody>
</table>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Check out the appendix for a list of all of the CQL types and their data size.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="imageblock">
<div class="content">
<img alt="formula partition size pk" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-partition-size-pk.svg" />
</div>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user physical pk" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-physical-pk.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Total size of partition key column(s): <strong>16 bytes</strong></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="imageblock">
<div class="content">
<img alt="formula partition size static" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-partition-size-static.svg" />
</div>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user physical static" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-physical-static.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Total size of static column(s): <strong>30 bytes</strong></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="imageblock">
<div class="content">
<img alt="formula partition size rows" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-partition-size-rows.svg" />
</div>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user physical" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-physical.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Number of CQL rows in partition: <strong>100</strong></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="imageblock">
<div class="content">
<img alt="formula partition size clustering" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-partition-size-clustering.svg" />
</div>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user physical clustering" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-physical-clustering.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Total size of clustering column(s):</li>
<li>8 + 16 = <strong>24 bytes</strong></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="imageblock">
<div class="content">
<img alt="formula partition size regular" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-partition-size-regular.svg" />
</div>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user physical regular" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-physical-regular.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Total size of regular columns(s):</li>
<li>(300 + 24) + (60 + 24) + (32768 + 24) = <strong>33,200 bytes</strong></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>For each regular column, take the size of the column and add the size of the clustering column(s).<br />
Then sum the size of all of the regular column(s).</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="imageblock">
<div class="content">
<img alt="formula partition size values" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-partition-size-values.svg" />
</div>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user physical" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-physical.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Number of values&#8201;&#8212;&#8201;from previous example: <strong>301</strong></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="imageblock">
<div class="content">
<img alt="formula partition size" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/formula-partition-size.svg" />
</div>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by user physical" src="images/cassandra/dev/data-modeling/physical/analysis-validation/partition-size/comments-by-user-physical.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>16 + 30 + (100 * 33200) + (8 * 301)</li>
<li>Result = <strong>3,322,454 bytes</strong> or <strong>~3.17 MB</strong></li>
</ul>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-13-partition-size">
<h2>Exercise 13&#8212;&#8203;Figuring out partition size</h2>

</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-analysis-validation-data-duplication-factor">
<h2>Data Duplication</h2>
<div class="paragraph"><p><strong>Data duplication comes from having multiple copies of the same data</strong></p></div>
<div class="ulist">
<ul>
<li>Byproduct of the modeling principles</li>
<li>Not replication&#8212;&#8203;Cassandra also duplicates data for availability and locality</li>
<li>Your dataset is 10 TB and your schema duplicates it 10 times with RF=5</li>
<li>The resulting amount of data stored in Cassandra is <strong>500 TB</strong></li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="data redundancy" src="images/cassandra/dev/data-modeling/physical/analysis-validation/data-duplication-factor/data-redundancy.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The modeling principles that can cause data redundancy includes partition per query data access, nesting data, and duplicating data.</p></div>
<div class="paragraph"><p>Since much of the duplication in Cassandra is intentional, you should plan for more nodes in a cluster to be able to handle the necessary duplication.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Issues to consider with redundant data</strong></p></div>
<div class="ulist">
<ul>
<li>Non-constant duplication factor</li>
<li>Data consistency</li>
</ul>
</div>
</section>
<section class="slide" id="analyzing-data-duplication">
<h2>Analyzing Data Duplication</h2>
<div class="paragraph"><p><strong>Duplication across tables</strong></p></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="comments-by-video-user" src="images/cassandra/dev/data-modeling/physical/analysis-validation/data-duplication-factor/comments-by-video-user.svg" /></span></p></div>
<div class="ulist">
<ul>
<li><p>
Copy of the same entity / relationship is stored in different tables<div class="ulist">
<ul>
<li>Each comment is stored once in <code>comments_by_video</code></li>
<li>Each comment is stored once in <code>comments_by_user</code></li>
</ul>
</div></p></li>
</ul>
</div>
<div class="ulist">
<ul>
<li>Duplication factor is a constant&#8201;&#8212;&#8201;2x</li>
<li>Usually not an issue</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Duplication across partitions</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="videos by actor" src="images/cassandra/dev/data-modeling/physical/analysis-validation/data-duplication-factor/videos-by-actor.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Copy of the same data is stored in the same table, but different partitions</li>
<li>A video with 5 actors is stored in 5 partitions</li>
</ul>
</div>
<div class="paragraph"><p></p></div>
<div class="ulist">
<ul>
<li>Duplication factor is a constant&#8201;&#8212;&#8201;5x</li>
<li>Usually not an issue</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Duplication across rows</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="videos by actor genre" src="images/cassandra/dev/data-modeling/physical/analysis-validation/data-duplication-factor/videos-by-actor-genre.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li><p>
Copy of the same data is stored in different rows of the same partition<div class="ulist">
<ul>
<li>A video with 5 actors is stored in 5 partitions</li>
<li>A video with 5 genres is stored in 5 rows in each actor partition</li>
</ul>
</div></p></li>
<li>Duplication factor is a constant&#8201;&#8212;&#8201;~25x</li>
<li>Usually not an issue</li>
</ul>
</div>
</section>
<section class="slide" id="issues-with-data-duplication">
<h2>Issues with Data Duplication</h2>
<div class="paragraph"><p><strong>If data duplication is not a constant</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="videos by actor tag" src="images/cassandra/dev/data-modeling/physical/analysis-validation/data-duplication-factor/videos-by-actor-tag.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Duplication factor grows with the dataset</li>
<li>Users can add new tags to videos</li>
<li><p>
There is no limit to the number of tags per video<div class="ulist">
<ul>
<li>A video with 5 actors is stored in 5 partitions</li>
<li>A video with <em>n</em> tags is stored in <em>n</em> rows</li>
<li>Duplication factor: 5 x n&#8201;&#8212;&#8201;linear function</li>
</ul>
</div></p></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Avoid non-constant duplication factors</strong></p></div>
<div class="ulist">
<ul>
<li>Linear</li>
<li>Quadratic</li>
<li>Higher order</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The 1:n and m:n relationship patterns may create these higher-order duplication factors when the attributes for the partitioned entity is not declared static.</p></div>
</div>
</div>
</section>
<section class="slide" id="non-constant-duplication-factors">
<h2>Non-Constant Duplication Factors</h2>
<div class="paragraph"><p><strong>How to deal with non-constant duplication factors</strong></p></div>
<div class="ulist">
<ul>
<li>Rethink a use case&#8212;&#8203;do things differently!</li>
<li><p>
Place reasonable limits that can be gradually increased<div class="ulist">
<ul>
<li>Number of tags</li>
<li>Number of playlists</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-analysis-validation-data-consistency">
<h2>Schema Data Consistency</h2>
<div class="paragraph"><p><strong>Schema data consistency refers to the correctness of data copies</strong></p></div>
<div class="ulist">
<ul>
<li>With data duplication, <strong>you</strong> need to worry about and handle consistency</li>
<li>All copies of the same data in your schema should have the same values</li>
<li>Adding, updating, or deleting data may require multiple INSERTs, UPDATEs and DELETEs</li>
<li>Logged batches were built for maintaining consistency</li>
<li>Have a documented plan!</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Schema data consistency is not the same as the distributed data consistency in Cassandra. Cassandra handles data consistency in the context of data replication and copies of the same data / partition on different nodes. This is done with tunable consistency and allows developers to balance their consistency needs with availability and performance.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Data consistency example</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="videos videos title" src="images/cassandra/dev/data-modeling/physical/analysis-validation/data-consistency/videos-videos-title.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>To insert a new video</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">INSERT</span> <span class="class">INTO</span> videos (video_id, ...)
   <span class="keyword">VALUES</span> (<span class="integer">1</span>, ...);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">INSERT</span> <span class="class">INTO</span> videos_by_title (title, video_id, ...)
   <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">Jaw</span><span class="delimiter">'</span></span>, <span class="integer">1</span>, ...);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>To update the title of a video</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">UPDATE</span> videos <span class="class">SET</span> title = <span class="string"><span class="delimiter">'</span><span class="content">Jaws</span><span class="delimiter">'</span></span> <span class="keyword">WHERE</span> video_id = <span class="integer">1</span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">INSERT</span> <span class="class">INTO</span> videos_by_title (title, video_id, ...)
   <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">Jaws</span><span class="delimiter">'</span></span>, <span class="integer">1</span>, ...);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">DELETE</span> <span class="keyword">FROM</span> videos_by_title <span class="keyword">WHERE</span> title = <span class="string"><span class="delimiter">'</span><span class="content">Jaw</span><span class="delimiter">'</span></span>
   <span class="keyword">AND</span> video_id = <span class="integer">1</span>;</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Example of using logged batch for data consistency</strong></p></div>
<div class="ulist">
<ul>
<li>To insert a new video</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">BEGIN</span> BATCH
   <span class="class">INSERT</span> <span class="class">INTO</span> videos (video_id, ...) <span class="keyword">VALUES</span> (<span class="integer">1</span>, ...);
   <span class="class">INSERT</span> <span class="class">INTO</span> videos_by_title (title, video_id, ...) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">Jaw</span><span class="delimiter">'</span></span>, <span class="integer">1</span>, ...
APPLY BATCH;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>To update the title of a video</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">BEGIN</span> BATCH
   <span class="class">UPDATE</span> videos <span class="class">SET</span> title = <span class="string"><span class="delimiter">'</span><span class="content">Jaws</span><span class="delimiter">'</span></span> <span class="keyword">WHERE</span> video_id = <span class="integer">1</span>;
   <span class="class">INSERT</span> <span class="class">INTO</span> videos_by_title (title, video_id, ...) <span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">Jaws</span><span class="delimiter">'</span></span>, <span class="integer">1</span>);
   <span class="class">DELETE</span> <span class="keyword">FROM</span> videos_by_title <span class="keyword">WHERE</span> title = <span class="string"><span class="delimiter">'</span><span class="content">Jaw</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> video_id = <span class="integer">1</span>;
APPLY BATCH;</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>More about batches</strong></p></div>
<div class="ulist">
<ul>
<li><p>
Written to a log on the coordinator node and replicas before execution<div class="ulist">
<ul>
<li>Batch succeeds when the writes have been applied or hinted</li>
<li>Replicas take over if the coordinator node fails mid-batch</li>
</ul>
</div></p></li>
<li><p>
Gets us part of the way to ACID transactions<div class="ulist">
<ul>
<li>No need for a rollback implementation since Cassandra will ensure that the batch succeeds</li>
<li>But no batch isolation&#8212;&#8203;clients may read updated rows before the batch completes</li>
</ul>
</div></p></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Misconception of batches</strong></p></div>
<div class="ulist">
<ul>
<li><p>
Not intended for bulk loading<div class="ulist">
<ul>
<li>Rarely increases performance of data load</li>
<li>Can overwork the coordinator and cause performance bottlenecks or other issues</li>
</ul>
</div></p></li>
<li>No ordering for operations in batches&#8212;&#8203;all writes are executed with the same timestamp</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The ideal way to perform bulk loading is to leverage asynchronous write operations with load balancing.</p></div>
<div class="paragraph"><p>A workaround to implement ordering for the statements in a batch can be done by explicitly providing a write timestamp for each statement with the <code>USING TIMESTAMP</code> clause.</p></div>
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-analysis-validation-client-side-joins">
<h2>Join Queries</h2>
<div class="ulist">
<ul>
<li>An operation that combines data from two or more tables</li>
<li>Rows from two tables are combined if they satisfy a join condition</li>
<li><p>
Joins are an expensive operation, based on:<div class="ulist">
<ul>
<li>Number of I/O operations</li>
<li>Number of nodes / partitions involved</li>
<li>Amount of data transferred</li>
<li>Join selectivity factor</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Join selectivity factor is a value that describes the ratio of selected rows in a table compared to total number of rows.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Cassandra does not support joins due to the performance cost</li>
<li>You can still manually perform a join from the client or application</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="icon-important" title="Important"></i>
</td>
<td class="content">
This should only be used with care, and keeping in mind the potential cost
</td>
</tr>
</table>
</div>
</section>
<section class="slide" id="eliminating-client-side-joins">
<h2>Eliminating Client-side Joins</h2>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="comments by video" src="images/cassandra/dev/data-modeling/physical/analysis-validation/client-side-joins/comments-by-video.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li><p>
Pre-compute and store a join result<div class="ulist">
<ul>
<li>Advantage: efficiency</li>
<li>Cost: possible data duplication</li>
</ul>
</div></p></li>
<li><p>
Examples<div class="ulist">
<ul>
<li>Find comments for all videos&#8201;&#8212;&#8201;queries a single table</li>
<li>Find comments for a specific video&#8201;&#8212;&#8201;queries a single partition</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The table <code>comments_by_video</code> duplicates data for <code>title</code>, <code>type</code>, <code>tags</code>, and <code>preview_thumbnails</code>, and would not need to retrieve these columns from other tables.</p></div>
</div>
</div>
</section>
<section class="slide" id="when-to-use-client-side-joins">
<h2>When To Use Client-side Joins</h2>
<div class="paragraph"><p><strong>Never, if you can avoid it</strong></p></div>
<div class="ulist">
<ul>
<li>Keep your queries efficient!</li>
<li>Balance between data duplication and increased data size needs to be considered</li>
<li>Going from 1 TB to 1 PB is possible, but does your budget allow for that?</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>When you have finite resources</strong></p></div>
<div class="ulist">
<ul>
<li><p>
A legitimate use case is when you need to cope with extensive data duplication<div class="ulist">
<ul>
<li>Can use <em>relatively</em> efficient joins</li>
<li>Finding a balance is not easy&#8201;&#8212;&#8201;NP-hard, a.k.a. super-freakin' hard!</li>
<li>A lookup query using a manually-built inverted index is a common scenario</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="using-an-inverted-index">
<h2>Using An Inverted Index</h2>
<div class="paragraph"><p><strong>Inverted index lookup&#8201;&#8212;&#8201;efficient index-based join</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="inverted index lookup" src="images/cassandra/dev/data-modeling/physical/analysis-validation/client-side-joins/inverted-index-lookup.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>An inverted index is a table that stores:</p></div>
<div class="ulist">
<ul>
<li>Values to search on</li>
<li>Identifiers that point to the raw data or content in another table</li>
</ul>
</div>
<div class="paragraph"><p>Storing the raw data again in the index table would be an expensive duplication.</p></div>
</div>
</div>
</section>
<section class="slide" id="referential-integrity">
<h2>Referential Integrity</h2>
<div class="ulist">
<ul>
<li>A value in one table requires the same value to exist in another table</li>
<li>If there is a user in table <code>users_by_email</code>, then the user must also exist in table <code>users</code></li>
</ul>
</div>
<div class="paragraph"><p><strong>Joins rely on referential integrity constraints to combine data</strong></p></div>
<div class="imageblock" style="float: center">
<div class="content">
<img alt="users users by email" src="images/cassandra/dev/data-modeling/physical/analysis-validation/client-side-joins/users-users-by-email.svg" />
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Referential integrity is not enforced in Cassandra</strong></p></div>
<div class="ulist">
<ul>
<li>Due to performance reasons&#8201;&#8212;&#8201;would require a read before a write</li>
<li>Not an issue that has to be fixed on the Cassandra side</li>
<li><p>
Referential integrity can be enforced in an application design&#8201;&#8212;&#8201;more work for developers<div class="ulist">
<ul>
<li>Batches used to modify duplicate data</li>
<li>Run Apache Spark on Cassandra to validate that duplicate data is consistent</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-analysis-validation-transactions">
<h2>Database Transaction</h2>
<div class="paragraph"><p><strong>ACID transaction&#8201;&#8212;&#8201;Sequence of statements with special properties</strong></p></div>
<table class="tableblock frame-all grid-all" style="width:100%">
<colgroup>
<col style="width:20%" />
<col style="width:80%" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Atomicity</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All statements in a transaction succeed (commit),<br />
or none of them do (rollback)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Consistency</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">- Transactions cannot leave the database in an inconsistent state<br />
- The new database state must satisfy transaction specifications<br />
- All integrity constraints are satisfied</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Isolation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transactions do not interfere with each other</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Durability</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Completed transactions persist in the event of subsequent failure</p></td>
</tr>
</tbody>
</table>
</section>
<section class="slide" id="transactions-in-cassandra">
<h2>Transactions In Cassandra</h2>
<div class="ulist">
<ul>
<li><p>
Cassandra does not support ACID transactions<div class="ulist">
<ul>
<li>They result in a significant performance penalty</li>
<li>Not required for many use cases</li>
</ul>
</div></p></li>
<li><p>
A single write operation demonstrates ACID properties<div class="ulist">
<ul>
<li>INSERTs, UPDATEs, and DELETEs are atomic, isolated, and durable</li>
<li>Tunable consistency for data replicated to nodes, but does not handle application integrity constraints</li>
</ul>
</div></p></li>
</ul>
</div>
</section>
<section class="slide" id="cassandra-lightweight-transactions">
<h2>Cassandra Lightweight Transactions</h2>
<div class="paragraph"><p><strong>Compare and Set (CAS) operation with ACID properties</strong></p></div>
<div class="ulist">
<ul>
<li>Does a read to check a condition, and performs the INSERT / UPDATE / DELETE if the condition is true</li>
<li>Essentially an ACID transaction at the partition level</li>
<li>More expensive than regular reads and writes</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="lightweight-transaction-1" src="images/cassandra/dev/data-modeling/physical/analysis-validation/transactions/lightweight-transaction-1.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Lightweight transactions are similar to serial isolation level in relational databases.</p></div>
<div class="paragraph"><p>The implementation of lightweight transactions is possible using a consensus protocol called Paxos.</p></div>
<div class="paragraph"><p>Even with multiple concurrent operations, the Paxos protocol ensures that only one operation is modifying a partition at a time, without the use of performance-reducing locks.</p></div>
<div class="paragraph"><p>However there is still a performance penalty since the implementation requires four round-trips between a coordinator and replica nodes.</p></div>
<div class="paragraph"><p>Lightweight transactions work at the partition-level&#8212;&#8203;the write condition and the write itself target the same partition.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Compare and Set (CAS) operation with ACID properties</strong></p></div>
<div class="ulist">
<ul>
<li>Does a read to check a condition, and performs the INSERT / UPDATE / DELETE if the condition is true</li>
<li>Essentially an ACID transaction at the partition level</li>
<li>More expensive than regular reads and writes</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="lightweight-transaction-2" src="images/cassandra/dev/data-modeling/physical/analysis-validation/transactions/lightweight-transaction-2.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Lightweight transactions are similar to serial isolation level in relational databases.</p></div>
<div class="paragraph"><p>The implementation of lightweight transactions is possible using a consensus protocol called Paxos.</p></div>
<div class="paragraph"><p>Even with multiple concurrent operations, the Paxos protocol ensures that only one operation is modifying a partition at a time, without the use of performance-reducing locks.</p></div>
<div class="paragraph"><p>However there is still a performance penalty since the implementation requires four round-trips between a coordinator and replica nodes.</p></div>
<div class="paragraph"><p>Lightweight transactions work at the partition-level&#8212;&#8203;the write condition and the write itself target the same partition.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Compare and Set (CAS) operation with ACID properties</strong></p></div>
<div class="ulist">
<ul>
<li>Does a read to check a condition, and performs the INSERT / UPDATE / DELETE if the condition is true</li>
<li>Essentially an ACID transaction at the partition level</li>
<li>More expensive than regular reads and writes</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="lightweight-transaction-3" src="images/cassandra/dev/data-modeling/physical/analysis-validation/transactions/lightweight-transaction-3.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Lightweight transactions are similar to serial isolation level in relational databases.</p></div>
<div class="paragraph"><p>The implementation of lightweight transactions is possible using a consensus protocol called Paxos.</p></div>
<div class="paragraph"><p>Even with multiple concurrent operations, the Paxos protocol ensures that only one operation is modifying a partition at a time, without the use of performance-reducing locks.</p></div>
<div class="paragraph"><p>However there is still a performance penalty since the implementation requires four round-trips between a coordinator and replica nodes.</p></div>
<div class="paragraph"><p>Lightweight transactions work at the partition-level&#8212;&#8203;the write condition and the write itself target the same partition.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Compare and Set (CAS) operation with ACID properties</strong></p></div>
<div class="ulist">
<ul>
<li>Does a read to check a condition, and performs the INSERT / UPDATE / DELETE if the condition is true</li>
<li>Essentially an ACID transaction at the partition level</li>
<li>More expensive than regular reads and writes</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="lightweight-transaction-4" src="images/cassandra/dev/data-modeling/physical/analysis-validation/transactions/lightweight-transaction-4.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Lightweight transactions are similar to serial isolation level in relational databases.</p></div>
<div class="paragraph"><p>The implementation of lightweight transactions is possible using a consensus protocol called Paxos.</p></div>
<div class="paragraph"><p>Even with multiple concurrent operations, the Paxos protocol ensures that only one operation is modifying a partition at a time, without the use of performance-reducing locks.</p></div>
<div class="paragraph"><p>However there is still a performance penalty since the implementation requires four round-trips between a coordinator and replica nodes.</p></div>
<div class="paragraph"><p>Lightweight transactions work at the partition-level&#8212;&#8203;the write condition and the write itself target the same partition.</p></div>
</div>
</div>
</section>
<section class="slide" id="using-lightweight-transactions">
<h2>Using Lightweight Transactions</h2>
<div class="paragraph"><p><strong>Create a new user</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="new user" src="images/cassandra/dev/data-modeling/physical/analysis-validation/transactions/new-user.svg" />
</div>
</div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">INSERT</span> <span class="class">INTO</span> users (user_id, first_name, last_name, email, password)
<span class="keyword">VALUES</span> (<span class="string"><span class="delimiter">'</span><span class="content">tlberglund</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Tim</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Berglund</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">tim.berglund@datastax.com</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">12345678</span><span class="delimiter">'</span></span>)
<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>;</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Generate a reset password token and reset the password</strong></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">UPDATE</span> users
<span class="class">SET</span> reset_token = <span class="integer">12345678</span>-abcd-abcd-abcd-abcd12345678
<span class="keyword">WHERE</span> user_id = <span class="string"><span class="delimiter">'</span><span class="content">tlberglund</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph"><p></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">UPDATE</span> users
<span class="class">SET</span> reset_token = <span class="predefined-constant">null</span>, password = <span class="string"><span class="delimiter">'</span><span class="content">trustno1</span><span class="delimiter">'</span></span>
<span class="keyword">WHERE</span> user_id = <span class="string"><span class="delimiter">'</span><span class="content">tlberglund</span><span class="delimiter">'</span></span>
<span class="keyword">IF</span> reset_token = <span class="integer">12345678</span>-abcd-abcd-abcd-abcd12345678;</code></pre>
</div>
</div>
</section>
<section class="slide" id="schema-design-with-transactions">
<h2>Schema Design With Transactions</h2>
<div class="paragraph"><p><strong>Lightweight transactions are not your only option!</strong></p></div>
<div class="ulist">
<ul>
<li><p>
Several other suitable design alternatives to consider<div class="ulist">
<ul>
<li>Write new values instead of updating previous values</li>
<li>Batches can help to approximate transactions</li>
<li>Use a processing system as middleware between applications and Cassandra</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>One example would be time-series data, which will write new values based on a timestamp and does not to update previous values.</p></div>
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-analysis-validation-data-aggregation">
<h2>Data Aggregation</h2>
<div class="paragraph"><p><strong>Built-in functions provide some summary form of data</strong></p></div>
<table class="tableblock frame-all grid-all" style="width:100%">
<caption class="title">Table 1. Aggregate Functions</caption>
<colgroup>
<col style="width:25%" />
<col style="width:50%" />
<col style="width:25%" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Function Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-center valign-top">Supported in Cassandra</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SUM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total value from a column within selected rows</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red">✘</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AVG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mean value of a column within selected rows</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red">✘</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Count of selected rows</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="green">✔</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Min value of a column within selected rows</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red">✘</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MAX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Max value of a column within selected rows</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="red">✘</span></p></td>
</tr>
</tbody>
</table>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Although COUNT is supported in Cassandra, it inefficiently has to do a full table scan while counting.<br />
Avoid queries that would use the COUNT function, especially in production.<br />
Cassandra 2.2 will have user-defined functions and aggregates, which will make the above functions available. See <a class="bare" href="http://cassandra.apache.org/doc/cql3/CQL-2.2.html#udfs">http://cassandra.apache.org/doc/cql3/CQL-2.2.html#udfs</a> and <a class="bare" href="http://cassandra.apache.org/doc/cql3/CQL-2.2.html#udas">http://cassandra.apache.org/doc/cql3/CQL-2.2.html#udas</a> for more details.</p></div>
</div>
</div>
</section>
<section class="slide" id="how-to-do-data-aggregation">
<h2>How To Do Data Aggregation</h2>
<div class="paragraph"><p><strong>Possible solutions</strong></p></div>
<div class="openblock slide">
<div class="content">
<div class="ulist">
<ul>
<li><p>
Update data aggregates on-the-fly in Cassandra<div class="ulist">
<ul>
<li>Same technique for linearizable transactions&#8212;&#8203;lightweight transactions</li>
<li>Counter type</li>
</ul>
</div></p></li>
</ul>
</div>
</div>
</div>
<div class="openblock slide">
<div class="content">
<div class="ulist">
<ul>
<li>Implement data aggregation on client-side</li>
</ul>
</div>
</div>
</div>
<div class="openblock slide">
<div class="content">
<div class="ulist">
<ul>
<li>Use Apache Spark for near real-time batch aggregation</li>
</ul>
</div>
</div>
</div>
<div class="openblock slide">
<div class="content">
<div class="ulist">
<ul>
<li>Use Apache Solr&#8201;&#8212;&#8201;Stats component</li>
</ul>
</div>
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The only solution done purely in Cassandra are: +</p></div>
<div class="ulist">
<ul>
<li>Lightweight transactions, which is discussed elsewhere</li>
<li>Counters, the focus of this section</li>
</ul>
</div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>The Counter type</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="ratings by video" src="images/cassandra/dev/data-modeling/physical/analysis-validation/data-aggregation/ratings-by-video.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Important data type for aggregation</li>
<li>Increment, decrement, add or subtract the current value</li>
<li>Counter operations internally requires a read before write</li>
<li>May not be 100% accurate&#8212;&#8203;it&#8217;s not an idempotent operation</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">UPDATE</span> ratings_by_video
<span class="class">SET</span> num_ratings = num_ratings + <span class="integer">1</span>,      <span class="comment">/* increment num_ratings by 1 */</span>
    sum_ratings = sum_ratings + <span class="integer">5</span>       <span class="comment">/* add 5 to the value of sum_ratings */</span>
<span class="keyword">WHERE</span> video_id = <span class="integer">12345678</span>-abcd-abcd-abcd-abcd12345678;</code></pre>
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The differentiation with counters is that the application doesn&#8217;t need to read or know what the current value of a column is. Cassandra will do that automatically and transparently.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Implementing data aggregation in an application</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="videos ratings" src="images/cassandra/dev/data-modeling/physical/analysis-validation/data-aggregation/videos-ratings.svg" />
</div>
</div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="ratings by video" src="images/cassandra/dev/data-modeling/physical/analysis-validation/data-aggregation/ratings-by-video.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Retrieve data from Cassandra</li>
<li>Aggregate data in an application</li>
<li>Store the result back in Cassandra</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Implementing data aggregation in an application</strong></p></div>
<div class="openblock slide">
<div class="content">
<div class="ulist">
<ul>
<li><p>
Periodically, query <strong>num_ratings</strong> and <strong>sum_ratings</strong><div class="listingblock">
<div class="content">
<pre class="CodeRay"><code>num_ratings: 58
sum_ratings = 477</code></pre>
</div>
</div></p></li>
</ul>
</div>
</div>
</div>
<div class="openblock slide">
<div class="content">
<div class="ulist">
<ul>
<li><p>
On the application side, compute <strong>sum_ratings</strong> / <strong>num_ratings</strong> to get <strong>avg_rating</strong><div class="listingblock">
<div class="content">
<pre class="CodeRay"><code>477 / 58 = 8.2, avg_rating: 8.2</code></pre>
</div>
</div></p></li>
</ul>
</div>
</div>
</div>
<div class="openblock slide">
<div class="content">
<div class="ulist">
<ul>
<li><p>
Update <strong>avg_rating</strong><div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">UPDATE</span> videos <span class="class">SET</span> avg_rating = <span class="float">8.2</span>
<span class="keyword">WHERE</span> video_id = <span class="integer">12345678</span>-abcd-abcd-abcd-abcd12345678;</code></pre>
</div>
</div></p></li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-14-data-aggregation">
<h2>Exercise 14&#8212;&#8203;Implementing aggregation in your data model</h2>

</section>
<section class="slide transition-green" id="courses-DS220-transitions-physical-fixing-problem">
<h2>Physical Optimization&#8212;&#8203;Fixing the Problems</h2>

</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-key-optimizations">
<h2>Keys</h2>
<div class="paragraph"><p><span class="image"><img alt="unique" src="images/cassandra/dev/data-modeling/physical/key-optimizations/unique.jpg" width="100%" /></span></p></div>
</section>
<section class="slide" id="traditional-relational-key">
<h2>Traditional Relational Key</h2>
<div class="ulist">
<ul>
<li>Uniqueness</li>
<li>Minimality</li>
</ul>
</div>
</section>
<section class="slide" id="uniqueness">
<h2>Uniqueness</h2>
<div class="ulist">
<ul>
<li>Choose column(s) that uniquely identify each object</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="uniqueness" src="images/cassandra/dev/data-modeling/physical/key-optimizations/uniqueness.svg" /></span></p></div>
<div class="paragraph notes"><p>A typical relational database key is the minimal sequence of columns/attributes that are unique. <em>title</em> is not guaranteed to be unique and makes a poor key choice for <em>videos</em>.</p></div>
</section>
<section class="slide" id="minimality">
<h2>Minimality</h2>
<div class="ulist">
<ul>
<li>Choose the minimum number of columns for uniqueness</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="minimality" src="images/cassandra/dev/data-modeling/physical/key-optimizations/minimality.svg" /></span></p></div>
<div class="paragraph notes"><p><em>video_id</em>, <em>user_id</em>, <em>title</em>, and <em>description</em> combined are too much to have unique values. <em>video_id</em> alone will suffice here.</p></div>
</section>
<section class="slide" id="cassandra-key">
<h2>Cassandra Key</h2>
<div class="paragraph"><p><span class="image"><img alt="primary-key" src="images/cassandra/dev/data-modeling/physical/key-optimizations/primary-key.svg" /></span></p></div>
<div class="paragraph notes"><p>Cassandra keys relax the minimality constraint because Cassandra primary keys define the partitioning key and clustering columns. We structure Cassandra keys to support a query.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="maintain-uniqueness" src="images/cassandra/dev/data-modeling/physical/key-optimizations/maintain-uniqueness.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="relax-minimality" src="images/cassandra/dev/data-modeling/physical/key-optimizations/relax-minimality.svg" /></span></p></div>
<div class="paragraph notes"><p>Cassandra relaxes the minimality constraint to structure tables which optimally serve a specific queries.</p></div>
</section>
<section class="slide" id="natural-keys">
<h2>Natural Keys</h2>
<div class="paragraph"><p><span class="image"><img alt="natural-keys-1" src="images/cassandra/dev/data-modeling/physical/key-optimizations/natural-keys-1.png" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Real world attributes form natural keys. They already exist, straightforward to derive, meaningful, and easy to query.</p></div>
<div class="paragraph"><p>Examples of this are taxpayer identifications numbers, employee identification numbers, email address, login/username, or a composite key of name, date of birth, and address.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="natural-keys-2" src="images/cassandra/dev/data-modeling/physical/key-optimizations/natural-keys-2.png" /></span></p></div>
</section>
<section class="slide" id="surrogate-key">
<h2>Surrogate Key</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="artificial" src="images/cassandra/dev/data-modeling/physical/key-optimizations/artificial.jpg" /></span></p></div>
<div class="ulist">
<ul>
<li>Artificial</li>
<li>Generated</li>
<li>Meaningless to outside world</li>
<li>Looks random</li>
</ul>
</div>
</section>
<section class="slide" id="surrogate-key-example">
<h2>Surrogate Key Example</h2>
<div class="paragraph"><p><span class="image"><img alt="surrogate-keys-1" src="images/cassandra/dev/data-modeling/physical/key-optimizations/surrogate-keys-1.png" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="surrogate-keys-2" src="images/cassandra/dev/data-modeling/physical/key-optimizations/surrogate-keys-2.png" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Identifying a user can be challenging because their name is not unique and their email address may change or not be a required attribute. Surrogate identifiers solve this problem.</p></div>
</div>
</div>
</section>
<section class="slide" id="surrogate-key-2">
<h2>Surrogate Key</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="artificial" src="images/cassandra/dev/data-modeling/physical/key-optimizations/artificial.jpg" /></span></p></div>
<div class="paragraph"><p><strong>Characteristics</strong></p></div>
<div class="ulist">
<ul>
<li>Conflict-free uniqueness</li>
<li>Immutable</li>
<li>Uniformity</li>
<li>Compactness</li>
<li>Performance</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Since surrogate keys are generated, they are guaranteed to be unique.</p></div>
<div class="paragraph"><p>Since the outside world does not track surrogate keys, they are immutable. Whereas a natural key value can change over time, making you update all values spread throughout your database.</p></div>
<div class="paragraph"><p>Surrogate keys all look the same, are compact, and take the same number of bytes, so they are naturally more performant than natural keys as well.</p></div>
</div>
</div>
</section>
<section class="slide" id="uniqueness-constraint-violations">
<h2>Uniqueness Constraint Violations</h2>
<div class="ulist">
<ul>
<li>Lightweight transactions prevent upserts</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">INSERT</span> <span class="class">INTO</span> users (id, first_name, last_name)
<span class="keyword">VALUES</span> (<span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">Data</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Stax</span><span class="delimiter">'</span></span>);

<span class="class">INSERT</span> <span class="class">INTO</span> users (id, first_name, last_name)
<span class="keyword">VALUES</span> (<span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">Cassy</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Andra</span><span class="delimiter">'</span></span>);
<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>;</code></pre>
</div>
</div>
<div class="paragraph notes"><p>Cassandra rejects the second insert because IF NOT EXISTS checks for a duplicate primary key value. There is a performance penalty with this approach, however, because Cassandra must perform a read before a write.</p></div>
</section>
<section class="slide" id="uniqueness-constraint-violations-2">
<h2>Uniqueness Constraint Violations</h2>
<div class="ulist">
<ul>
<li>Lightweight transactions only verify key values</li>
<li>Surrogate keys may allow duplicate records</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">INSERT</span> <span class="class">INTO</span> users (id, first_name, last_name)
<span class="keyword">VALUES</span> (<span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">Data</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Stax</span><span class="delimiter">'</span></span>)
<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>;

<span class="class">INSERT</span> <span class="class">INTO</span> users (id, first_name, last_name)
<span class="keyword">VALUES</span> (<span class="integer">42</span>, <span class="string"><span class="delimiter">'</span><span class="content">Data</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Stax</span><span class="delimiter">'</span></span>)
<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>;</code></pre>
</div>
</div>
<div class="paragraph notes"><p>Your application must verify non-key column values for uniqueness when desired. Here we insert what could possibly be the same user twice. Cassandra (nor any other database) allows this because the actual key values are unique.</p></div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-table-optimizations">
<h2>Table Optimizations</h2>
<div class="paragraph"><p><strong>Fixing the problem</strong></p></div>
<div class="ulist">
<ul>
<li>Splitting partitions&#8212;&#8203;size manageability</li>
<li>Vertical partitioning&#8212;&#8203;speed</li>
<li>Merging partitions and tables&#8212;&#8203;speed and eliminate duplication</li>
<li>Adding columns&#8212;&#8203;speed</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>All of these optimizations work towards faster query response time. We will discuss why each of these may be necessary and how we apply them.</p></div>
</div>
</div>
</section>
<section class="slide" id="splitting-partitions-in-a-table">
<h2>Splitting Partitions in a Table</h2>
<div class="ulist">
<ul>
<li>Partitions may grow too large</li>
</ul>
</div>
<div class="paragraph"><p>Example:</p></div>
<div class="ulist">
<ul>
<li>Highly active user with 1,000 video interactions (pause, play, seek, etc.) per day will exceed the recommended partition value limit in two months</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img alt="video interactions by user" src="images/cassandra/dev/data-modeling/physical/table-optimizations/video-interactions-by-user.svg" />
</div>
</div>
<div class="paragraph notes"><p>The recommended max partition size is 100MBs or 100,000 values. There are two values per interaction in this table. A user will exceed this limit after 50,000 interactions.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>General strategy</strong></p></div>
<div class="paragraph"><p><strong>Add another column to a partition key</strong></p></div>
<div class="ulist">
<ul>
<li>Existing column</li>
<li>Artificial column</li>
</ul>
</div>
<div class="paragraph"><p><strong>Rationale</strong></p></div>
<div class="ulist">
<ul>
<li>Fewer rows per partition</li>
</ul>
</div>
<div class="paragraph notes"><p>Adding a column to the partition key divides the rows between more partitions because the additional column value adds another level of uniqueness between rows.</p></div>
</section>
<section class="slide" id="using-an-existing-column">
<h2>Using an Existing Column</h2>
<div class="paragraph"><p><strong>Convenient</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="split part existing" src="images/cassandra/dev/data-modeling/physical/table-optimizations/split-part-existing.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>The table on the left stores all interactions for a single user into one partition. The optimized table on the right divides these interactions by each video the user interacts with.</p></div>
<div class="paragraph"><p>This optimization also satisfies "partition per query" design methodology for its original query:</p></div>
<div class="paragraph"><p>Q10: Find the video interactions for a user with a known id and specified video id (show the most recent interactions first).</p></div>
</div>
</div>
</section>
<section class="slide" id="using-an-artificial-column">
<h2>Using an Artificial Column</h2>
<div class="paragraph"><p><strong>Can control distribution</strong></p></div>
<div class="imageblock">
<div class="content">
<img alt="split part artificial" src="images/cassandra/dev/data-modeling/physical/table-optimizations/split-part-artificial.svg" />
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>event_date would track only the day portion of the event (the time would be set to midnight and ignored, etc.). It is the application&#8217;s responsibility to maintain this invariant. This divides partitions by days. You have more control because you can tweak event_date to track weeks, months, years, etc. instead of single days.</p></div>
<div class="paragraph"><p>Querying a user&#8217;s interactions over several days would then require retrieving multiple partitions. Having split the partition may be faster, however, because multiple nodes can concurrently retrieve and stream results instead of placing the load on a single node.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Take more control with "bucket" column</strong></p></div>
<div class="paragraph"><p><span class="image"><img alt="split-part-bucket" src="images/cassandra/dev/data-modeling/physical/table-optimizations/split-part-bucket.svg" /></span></p></div>
<div class="paragraph notes"><p>You can take explicit control by dividing the values yourself into a number of buckets. You determine your max bucket value, and then your application must ensure that each row&#8217;s bucket value is uniform.</p></div>
</section>
<section class="slide" id="vertical-partitioning-splitting-tables">
<h2>Vertical Partitioning (Splitting Tables)</h2>
<div class="paragraph"><p><strong>Benefits of vertical partitioning</strong></p></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="slice-board" src="images/cassandra/dev/data-modeling/physical/table-optimizations/slice-board.jpg" width="50%" /></span></p></div>
<div class="ulist">
<ul>
<li>Some queries may perform faster</li>
<li>Table partitions become smaller</li>
<li>Faster to retrieve and more of them can be cached</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="split-table-1" src="images/cassandra/dev/data-modeling/physical/table-optimizations/split-table-1.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="split-table-2" src="images/cassandra/dev/data-modeling/physical/table-optimizations/split-table-2.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>In this example, users will query for video metadata more often than watching the video. We split the video streaming data to its own table so our application does not unnecessarily pull it when displaying just the title, tags, etc.</p></div>
<div class="paragraph"><p>Depending on your queries, you may need to adjust the primary key when you split a table.</p></div>
<div class="paragraph"><p>Be careful to ensure that you don&#8217;t lose or orphan records in either table when performing the split. For example, if we are not careful in our application, we could store Interstellar&#8217;s metadata but fail to also store its streaming blob (or vice-versa).</p></div>
<div class="paragraph"><p>Also ensure that you don&#8217;t require client-side joins when splitting a table. For example, splitting the streaming blob here seems like a good choice, but if we never allowed users to view video metadata without watching the video in the same action, we forced our application to do two queries now instead of one.</p></div>
<div class="paragraph"><p>(Of course, what video streaming service would force you to watch a video before viewing the title, description, perhaps the cover art, etc. :)</p></div>
</div>
</div>
</section>
<section class="slide" id="merging-tables-and-partitions">
<h2>Merging Tables and Partitions</h2>
<div class="paragraph"><p><strong>Reverse of vertical partitioning</strong></p></div>
<div class="ulist">
<ul>
<li>Helpful to eliminate duplication</li>
<li>May result in slower queries</li>
</ul>
</div>
</section>
<section class="slide" id="merging-multiple-partitions">
<h2>Merging Multiple Partitions</h2>
<div class="paragraph"><p><strong>General strategy</strong></p></div>
<div class="ulist">
<ul>
<li>Introduce a new partition key and nest objects into new partitions</li>
<li>Partition key may consist of existing or artificial columns</li>
<li>Which of these three is the best choice?</li>
</ul>
</div>
<div class="imageblock" style="float: left">
<div class="content">
<img alt="physical merge partition" src="images/cassandra/dev/data-modeling/physical/table-optimizations/physical-merge-partition.svg" />
</div>
</div>
<div class="ulist notes">
<ul>
<li>Smaller partitions accessed by a query may be merged into one or a few larger partitions</li>
</ul>
</div>
</section>
<section class="slide" id="adding-columns-to-a-table">
<h2>Adding Columns to a Table</h2>
<div class="paragraph"><p><strong>Example&#8212;&#8203;Computing an average rating</strong></p></div>
<div class="imageblock" style="float: left">
<div class="content">
<img alt="physical add columns" src="images/cassandra/dev/data-modeling/physical/table-optimizations/physical-add-columns.svg" />
</div>
</div>
<div class="ulist notes">
<ul>
<li>Columns that are used in a query to avoid a join&#8212;&#8203;possible duplication and faster queries</li>
<li>Columns that store aggregate values for faster access</li>
</ul>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-15-table-optimization">
<h2>Exercise 15&#8212;&#8203;Table optimizations</h2>

</section>
<section class="slide" id="cassandra-dev-data-modeling-physical-concurrent-access">
<h2>Concurrent Access To Data</h2>
<div class="ulist">
<ul>
<li>Multiple operations or transactions read and update the same value in a database</li>
<li>Concurrent execution improves performance</li>
<li>Concurrent execution may result in data consistency (correctness) problems</li>
<li>Example&#8212;&#8203;two users submit their vote for video concurrently</li>
</ul>
</div>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="con access votes" src="images/cassandra/dev/data-modeling/physical/concurrent-access/con-access-votes.svg" />
</div>
</div>
</section>
<section class="slide" id="concurrent-access-using-counter-datatype">
<h2>Concurrent Access Using Counter Datatype</h2>
<div class="paragraph"><p><strong>Use COUNTER data type</strong></p></div>
<div class="ulist">
<ul>
<li>Correctness is not guaranteed</li>
<li>Limited to integral columns and operations of addition or subtraction</li>
<li>Performance penalty</li>
</ul>
</div>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="con access counter" src="images/cassandra/dev/data-modeling/physical/concurrent-access/con-access-counter.svg" />
</div>
</div>
</section>
<section class="slide" id="concurrent-access-using-lightweight-transactions">
<h2>Concurrent Access Using Lightweight Transactions</h2>
<div class="paragraph"><p><strong>Use lightweight transactions</strong></p></div>
<div class="ulist">
<ul>
<li>Correctness is guaranteed</li>
<li>Any update operation</li>
<li>Performance penalty</li>
<li>Failed LWTs must be repeated</li>
</ul>
</div>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="con access LWT" src="images/cassandra/dev/data-modeling/physical/concurrent-access/con-access-LWT.svg" />
</div>
</div>
</section>
<section class="slide" id="isolate-computation-by-isolating-data">
<h2>Isolate Computation by Isolating Data</h2>
<div class="ulist">
<ul>
<li>Correctness is not an issue (no concurrent access)</li>
<li>Commutative update operations are easier to deal with</li>
<li>Fast writes&#8212;&#8203;more space required</li>
<li>Data aggregation must be done by an application</li>
<li>An aggregate value can be stored back to C*</li>
</ul>
</div>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="con access isolating" src="images/cassandra/dev/data-modeling/physical/concurrent-access/con-access-isolating.svg" />
</div>
</div>
</section>
<section class="slide transition-purple" id="courses-DS220-exercise-placeholders-exercise-16-finalizing-physical">
<h2>Exercise 16&#8212;&#8203;Finalizing your physical data model</h2>

</section>
<section class="slide transition-green" id="courses-DS220-transitions-use-case-transition">
<h2>Use Cases</h2>

</section>
<section class="slide" id="cassandra-dev-data-modeling-use-cases">
<h2>When is Cassandra a good choice?</h2>
<div class="paragraph"><p><span class="image"><img alt="cassandra-strong-points" src="images/cassandra/dev/data-modeling/use-cases/cassandra-strong-points.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="ulist">
<ul>
<li><p>
Operational/transactional<div class="ulist">
<ul>
<li>Vast majority of relational data use cases</li>
<li>Structured and semi-structured data</li>
</ul>
</div></p></li>
<li><p>
Big data<div class="ulist">
<ul>
<li>Volume, Velocity, and Variety</li>
<li>Efficiency and scalability</li>
</ul>
</div></p></li>
<li><p>
Cassandra is always-on<div class="ulist">
<ul>
<li>Extremely high availability and partition tolerance</li>
<li>Seamless multi data center support</li>
</ul>
</div></p></li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide" id="main-functional-use-cases">
<h2>Main Functional Use Cases</h2>
<table class="tableblock frame-all grid-all" style="width:100%">
<colgroup>
<col style="width:50%" />
<col style="width:50%" />
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Use Case</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Product catalogs and playlists</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Collection of items</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Internet of things</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sensor data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messaging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Emails, instant messages, alerts, comments</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recommendation and personalization</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trend information</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fraud detection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data patterns</p></td>
</tr>
</tbody>
</table>
</section>
<section class="slide" id="what-companies-use-cassandra">
<h2>What companies use Cassandra?</h2>
<div class="paragraph"><p><span class="image"><img alt="cassandra-using-companies" src="images/cassandra/dev/data-modeling/use-cases/cassandra-using-companies.png" /></span></p></div>
</section>
<section class="slide transition-green" id="courses-DS220-transitions-sensor-data-transition">
<h2>Sensor Data Use Case</h2>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="sensor data" src="images/courses/DS220/transitions/sensor-data-transition/sensor-data.jpg" />
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-use-cases-sensor-data">
<h2>What are sensor applications?</h2>
<div class="ulist">
<ul>
<li>Agriculture</li>
<li>Environment and natural resources</li>
<li>Healthcare and wellness</li>
<li>Homeland security</li>
<li>Military</li>
<li>Monitoring and control</li>
<li>Retail</li>
<li>Robotics and automation</li>
<li>Smart home/office/auto</li>
<li>Telematics</li>
<li>Utilities</li>
</ul>
</div>
</section>
<section class="slide" id="sensor-data-use-case-introduction">
<h2>Sensor Data Use Case Introduction</h2>
<div class="paragraph"><p><strong>Data description</strong></p></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="network" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/network.png" /></span><br />
<span class="image" style="float: right"><img alt="sensor" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/sensor.jpg" width="70%" /></span></p></div>
<div class="ulist">
<ul>
<li>Multiple sensor networks are deployed over non-overlapping regions</li>
<li>A sensor network is identified by a unique name</li>
<li>A sensor belongs to exactly one network</li>
<li><p>
A sensor has a unique identifier, location, and other characteristics (e.g. accuracy, cost, manufacturing date)<div class="ulist">
<ul>
<li>Not all sensors have the same characteristics</li>
</ul>
</div></p></li>
<li>A sensor records new measurements (temperature, humidity, pressure) every second</li>
</ul>
</div>
<div class="paragraph slide"><p><strong>Diagram the conceptual model for this domain</strong></p></div>
</section>
<section class="slide" id="conceptual-data-model">
<h2>Conceptual Data Model</h2>
<div class="imageblock">
<div class="content">
<img alt="conceptual data model" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/conceptual-data-model.svg" />
</div>
</div>
<div class="openblock slide">
<div class="content">
<div class="paragraph"><p><strong>Relationship Keys</strong></p></div>
<div class="ulist">
<ul>
<li><span class="blue"><strong>has</strong></span>: sensor id</li>
<li><span class="blue"><strong>records</strong></span> and <span class="blue"><strong>Measurement</strong></span>: sensor id, timestamp, parameter</li>
</ul>
</div>
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Measurement&#8217;s <span class="emphasis"><strong>parameter</strong></span> attribute indicates <span class="emphasis"><strong>value</strong></span>'s unit (temperature, humidity, etc.). In this example, we always record temperature.</p></div>
<div class="paragraph"><p>Recall that the double-lined diamond indicates an identifying relationship. The double-lined <span class="emphasis"><strong>Measurement</strong></span> indicates a weak entity type. Thus, a <span class="emphasis"><strong>Measurement</strong></span> cannot exist without an identifying <span class="emphasis"><strong>Sensor</strong></span>. If we delete a <span class="emphasis"><strong>Sensor</strong></span>, we must delete all of its associated <span class="emphasis"><strong>Measurements</strong></span>. Without a <span class="emphasis"><strong>Sensor</strong></span>, the <span class="emphasis"><strong>Measurement</strong></span> does not have a <span class="emphasis"><strong>location</strong></span> or <span class="emphasis"><strong>characteristics</strong></span>.</p></div>
<div class="paragraph"><p>The key of the weak entity type also depends on the key of the strong entity type in the identifying relationship. Thus, <span class="emphasis"><strong>Sensor</span></strong>'s <span class="emphasis"><strong>id</strong></span> makes part of <span class="emphasis"><strong>Measurement</strong></span>'s key, as the slide indicates.</p></div>
</div>
</div>
</section>
<section class="slide" id="application-queries">
<h2>Application Queries</h2>
<div class="ulist">
<ul>
<li>Q<sub>1</sub>: Find information about all networks; order by name (ASC)</li>
<li>Q<sub>2</sub>: Find the average hourly temperature within a date range for a network’s sensors; order by date (DESC) and hour (DESC)</li>
<li>Q<sub>3</sub>: Find information about all sensors in a specified network</li>
<li>Q<sub>4</sub>: Find raw measurements for a sensor on a given date; order by timestamp (DESC)</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Q2 is an example of time series data. We order by date and then hour.</p></div>
<div class="paragraph"><p>Q4 is an another example of time series data. Sensors continually collect data and store that data with their timestamp.</p></div>
</div>
</div>
</section>
<section class="slide" id="application-workflow">
<h2>Application Workflow</h2>
<div class="imageblock">
<div class="content">
<img alt="application workflow" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/application-workflow.svg" />
</div>
</div>
<div class="paragraph slide"><p><strong>Diagram the logical data model for this workflow</strong></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>We organize our queries by work flow. The first query retrieves all networks, identified by their names (a number in this case).</p></div>
<div class="paragraph"><p>The second query uses the network name to retrieve the hourly average temperature in a given date range. We can then generate a heat map for a single point in time. We can also generate a heat-map animation over a time range.</p></div>
<div class="paragraph"><p>The third query enables us to produce a geographical image of all of our sensors. The user can then select a sensor for which we can further provide the raw data for a specific day via the fourth query.</p></div>
</div>
</div>
</section>
<section class="slide" id="logical-data-model">
<h2>Logical Data Model</h2>
<div class="imageblock">
<div class="content">
<img alt="logical data model" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/logical-data-model.svg" />
</div>
</div>
<div class="paragraph"><p><strong>Access Patterns</strong></p></div>
<div class="ulist">
<ul>
<li>Q<sub>1</sub>: Find information about all networks; order by name (ASC)</li>
<li>Q<sub>2</sub>: Find the average hourly temperature within a date range for a network’s sensors; order by date (DESC) and hour (DESC)</li>
<li>Q<sub>3</sub>: Find information about all sensors in a specified network</li>
<li>Q<sub>4</sub>: Find raw measurements for a sensor on a given date; order by timestamp (DESC)</li>
</ul>
</div>
</section>
<section class="slide" id="analysis-networks">
<h2>Analysis - networks</h2>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="networks analysis 1" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/networks-analysis-1.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Small partition size</li>
<li>Single row partitions</li>
<li>Small partitions</li>
</ul>
</div>
</section>
<section class="slide" id="analysis-networks-2">
<h2>Analysis - networks</h2>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="networks analysis 1" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/networks-analysis-1.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Small partition size</li>
<li>Single row partitions</li>
<li>Small partitions</li>
</ul>
</div>
<div class="paragraph"><p>How could we optimize this table for "partition per query" access pattern?</p></div>
<div class="ulist">
<ul>
<li>Q<sub>1</sub>: Find information about all networks; order by name (ASC)</li>
</ul>
</div>
</section>
<section class="slide" id="analysis-networks-3">
<h2>Analysis - networks</h2>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="networks analysis 2" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/networks-analysis-2.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>Small partition size</li>
<li>Single row partitions</li>
<li>Small partitions</li>
</ul>
</div>
<div class="paragraph"><p>How could we optimize this table for "partition per query" access pattern?</p></div>
<div class="ulist">
<ul>
<li>Q<sub>1</sub>: Find information about all networks; order by name (ASC)</li>
</ul>
</div>
<div class="paragraph"><p><strong>Optimization</strong></p></div>
<div class="ulist">
<ul>
<li>Merge small partitions into a larger partition</li>
<li>One small partition</li>
</ul>
</div>
</section>
<section class="slide" id="analysis-temperatures_by_network">
<h2>Analysis - temperatures_by_network</h2>
<div class="paragraph"><p><strong>Partition Size</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="temperatures by network analysis" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>At most 1,000 sensors per network</li>
<li>24 hours per day</li>
</ul>
</div>
<div class="openblock slide">
<div class="content">
<div class="paragraph"><p>Q<sub>2</sub>: Find the average hourly temperature within a date range for a network’s sensors; order by date (DESC) and hour (DESC)</p></div>
<div class="paragraph"><p><strong>How many records per partition per year? Is it too much?</strong></p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Partition Size</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="temperatures by network analysis" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis.svg" />
</div>
</div>
<div class="ulist">
<ul>
<li>365 x 24 x 1000 = 8,765,000</li>
<li>8,765,000 x (7 – 4 – 1) + 1 = 17.5+ million values</li>
<li>Large partition</li>
</ul>
</div>
<div class="paragraph slide"><p>What can we do to minimize partition size?</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Partition Size</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="temperatures by network analysis" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis.svg" />
</div>
</div>
<div class="paragraph"><p>Monthly partitions?</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Partition Size</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="temperatures by network analysis" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis.svg" />
</div>
</div>
<div class="paragraph"><p>Monthly partitions?</p></div>
<div class="ulist">
<ul>
<li>30 x 24 x 1000 = 720,000</li>
<li>720,000 x (7 – 4 – 1) + 1 = 1.4+ million values</li>
<li>Somewhat manageable</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Partition Size</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="temperatures by network analysis" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis.svg" />
</div>
</div>
<div class="paragraph"><p>Weekly partitions?</p></div>
<div class="paragraph notes"><p>The partition size for <span class="emphasis"><strong>Temperatures_by_network</strong></span> will grow too large. In one partition, we accumulate 1,000 average temperatures every hour. Although we may handle this for the first month, our partition sizes will quickly become unmanageable. We fix this by dividing our partitions by weeks.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Partition Size</strong></p></div>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="temperatures by network analysis" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis.svg" />
</div>
</div>
<div class="paragraph"><p>Weekly partitions?</p></div>
<div class="ulist">
<ul>
<li>7 x 24 x 1000 = 168,000</li>
<li>168,000 x (7 – 4 – 1) + 1 = 336,001 values</li>
<li>Around 26.3 MBs</li>
<li>Manageable partitions</li>
</ul>
</div>
<div class="paragraph slide"><p>How do we modify our physical <strong>temperatures_by_network</strong> data model to accommodate weekly partitions?</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="temperatures-by-network-analysis-1" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis-1.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="temperatures-by-network-analysis-2" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis-2.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="temperatures-by-network-analysis-3" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis-3.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="temperatures-by-network-analysis-4" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-analysis-4.svg" /></span></p></div>
</section>
<section class="slide" id="analysis-sensor_by_network">
<h2>Analysis - sensor_by_network</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="sensors-by-network-analysis-1" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/sensors-by-network-analysis-1.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Q<sub>3</sub>: Find information about all sensors in a specified network</li>
<li>At most 1,000 sensors per network</li>
<li>Manageable?</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="sensors-by-network-analysis-2" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/sensors-by-network-analysis-2.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Q<sub>3</sub>: Find information about all sensors in a specified network</li>
<li>At most 1,000 sensors per network</li>
<li>Manageable?</li>
<li>Yes!</li>
</ul>
</div>
</section>
<section class="slide" id="analysis-measurements_by_sensor">
<h2>Analysis - measurements_by_sensor</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="measurements-by-sensor-logical" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/measurements-by-sensor-logical.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>A sensor records a measurement every second</li>
<li>Manageable partitions?</li>
</ul>
</div>
<div class="ulist">
<ul>
<li class="slide">86,400 seconds per day</li>
<li class="slide">One measurement per second</li>
<li class="slide"><p>
One year (365 days): 31,536,000 measurements<div class="ulist">
<ul>
<li>Too many</li>
</ul>
</div></p></li>
<li class="slide"><p>
One month (30 days): 2,592,000 measurements<div class="ulist">
<ul>
<li>Too many</li>
</ul>
</div></p></li>
<li class="slide"><p>
One week (7 days): 604,800 measurements<div class="ulist">
<ul>
<li>Manageable</li>
<li>~11.5 MBs</li>
</ul>
</div></p></li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="measurements-by-sensor-analysis-1" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/measurements-by-sensor-analysis-1.svg" /></span></p></div>
<div class="paragraph"><p>How can we modify <strong>measurements_by_sensor</strong> to store weekly measurements per partition?</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="measurements-by-sensor-analysis-2" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/measurements-by-sensor-analysis-2.svg" /></span></p></div>
<div class="paragraph"><p>How can we modify <strong>measurements_by_sensor</strong> to store weekly measurements per partition?</p></div>
</section>
<section class="slide" id="analysis-measurements_by_sensor-2">
<h2>Analysis - measurements_by_sensor</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="measurements-by-sensor-analysis-3" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/measurements-by-sensor-analysis-3.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>The <em>timestamp</em> column redundantly stores the same year and hour as <em>week_first_day</em></li>
<li>How can we optimize this?</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="measurements-by-sensor-analysis-4" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/measurements-by-sensor-analysis-4.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>The <em>timestamp</em> column redundantly stores the same year and hour as <em>week_first_day</em></li>
<li>How can we optimize this?</li>
</ul>
</div>
</section>
<section class="slide" id="analysis-duplication">
<h2>Analysis - Duplication</h2>
<div class="paragraph"><p><strong>Physical Data Model</strong></p></div>
<div class="paragraph"><p><span class="image"><img alt="physical-region-duplication" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/physical-region-duplication.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="physical-region-duplication" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/physical-region-duplication.svg" /></span></p></div>
<div class="ulist">
<ul>
<li class="slide"><p>
<strong>networks</strong> stores <em>region</em> once per row<div class="ulist">
<ul>
<li>Once per network</li>
</ul>
</div></p></li>
<li class="slide"><p>
<strong>temperatures_by_network</strong> stores <em>region</em> once per partition as static value<div class="ulist">
<ul>
<li>Once per network per week</li>
</ul>
</div></p></li>
<li class="slide">Necessary duplication</li>
<li class="slide">Not detrimental</li>
</ul>
</div>
<div class="paragraph notes"><p>Although region appears in <span class="emphasis"><strong>networks</strong></span> and <span class="emphasis"><strong>temperatures_by_network</strong></span>, duplication is minimal. In <span class="emphasis"><strong>networks</strong></span>, <span class="emphasis"><strong>region</strong></span> will be a unique value. In <span class="emphasis"><strong>temperatures_by_network</strong></span>, <span class="emphasis"><strong>region</strong></span> is a static column.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="physical-location-duplication" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/physical-location-duplication.svg" /></span></p></div>
<div class="ulist">
<ul>
<li class="slide"><p>
<strong>temperatures_by_network</strong> stores location once per 7 X 24<div class="ulist">
<ul>
<li>Once per network per week per hour per sensor</li>
</ul>
</div></p></li>
<li class="slide"><strong>sensor_by_network</strong> stores location once</li>
<li class="slide"><p>
Duplication necessary to avoid joins<div class="ulist">
<ul>
<li>"Partition per query"</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="paragraph notes"><p><strong>temperatures_by_network</strong> duplicates <code>location</code> 168 times for every week</p></div>
</section>
<section class="slide" id="physical-data-model">
<h2>Physical Data Model</h2>
<div class="openblock slide">
<div class="content">
<div class="ulist">
<ul>
<li>Write the CQL DDL statements to create this physical model</li>
<li>Write CQL queries to satisfy each access pattern</li>
</ul>
</div>
</div>
</div>
<div class="paragraph"><p><span class="image"><img alt="physical-data-model-final" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/physical-data-model-final.svg" /></span></p></div>
</section>
<section class="slide" id="physical-data-model-networks">
<h2>Physical Data Model - networks</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="networks-physical" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/networks-physical.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> networks (
        bucket       <span class="predefined-type">INT</span>,
        number       <span class="predefined-type">INT</span>,
        description  <span class="predefined-type">TEXT</span>,
        region       <span class="predefined-type">TEXT</span>,
        n_sensors    <span class="predefined-type">INT</span>,
        <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((bucket), number)
);

Q1:
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> networks
<span class="keyword">WHERE</span> bucket = <span class="integer">1</span>;</code></pre>
</div>
</div>
<div class="paragraph notes"><p>Throughout this and the next three slides, notice that the queries are simple because we designed our tables specifically to support them.</p></div>
</section>
<section class="slide" id="physical-data-model-temperatures_by_network">
<h2>Physical Data Model - temperatures_by_network</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="temperatures-by-network-physical" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/temperatures-by-network-physical.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> temperatures_by_network (
        network         <span class="predefined-type">INT</span>,
        week_first_day  <span class="predefined-type">TIMESTAMP</span>,
        date_hour       <span class="predefined-type">TIMESTAMP</span>,
        sensor          <span class="predefined-type">TEXT</span>,
        avg_temp        <span class="predefined-type">FLOAT</span>,
        location        <span class="predefined-type">TEXT</span>,
        region          <span class="predefined-type">TEXT</span> STATIC,
        <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((network, week_first_day), date_hour, sensor)
) WITH CLUSTERING <span class="keyword">ORDER</span> <span class="keyword">BY</span> (date_hour <span class="directive">DESC</span>, sensor <span class="directive">ASC</span>);

Q2:
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> temperatures_by_network
<span class="keyword">WHERE</span> network = <span class="error">?</span> <span class="keyword">AND</span> week_first_day = <span class="error">?</span>
           <span class="keyword">AND</span> date_hour &gt;= <span class="error">?</span> <span class="keyword">AND</span> date_hour &lt;= <span class="error">?</span>;</code></pre>
</div>
</div>
</section>
<section class="slide" id="physical-data-model-sensors_by_network">
<h2>Physical Data Model - sensors_by_network</h2>
<div class="imageblock" style="float: right">
<div class="content">
<img alt="sensors by network physical" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/sensors-by-network-physical.svg" />
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> sensors_by_network (
        network         <span class="predefined-type">INT</span>,
        sensor          <span class="predefined-type">TEXT</span>,
        location        <span class="predefined-type">TEXT</span>,
        characteristics MAP&lt;<span class="predefined-type">TEXT</span>,<span class="predefined-type">TEXT</span>&gt;,
        <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((network), sensor)
);

Q3:
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> sensors_by_network
<span class="keyword">WHERE</span> network = <span class="error">?</span>;</code></pre>
</div>
</div>
</section>
<section class="slide" id="physical-data-model-measurements_by_sensor">
<h2>Physical Data Model - measurements_by_sensor</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="measurements-by-sensor-physical" src="images/cassandra/dev/data-modeling/use-cases/sensor-data/measurements-by-sensor-physical.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> measurements_by_sensor (
        sensor          <span class="predefined-type">TEXT</span>,
        parameter       <span class="predefined-type">TEXT</span>,
        week_first_day  <span class="predefined-type">TIMESTAMP</span>,
        second          <span class="predefined-type">INT</span>,
        value           <span class="predefined-type">FLOAT</span>,
        <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((sensor, parameter, week_first_day), second)
) WITH CLUSTERING <span class="keyword">ORDER</span> <span class="keyword">BY</span> (second <span class="directive">DESC</span>);

Q4:
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> measurements_by_sensor
<span class="keyword">WHERE</span> sensor = <span class="error">?</span> <span class="keyword">AND</span> <span class="predefined-type">date</span> = <span class="error">?</span> <span class="keyword">AND</span> week_first_day = <span class="error">?</span>;</code></pre>
</div>
</div>
</section>
<section class="slide transition-blue" id="courses-DS220-transitions-messaging-transition">
<h2>Messaging Use Case</h2>
<div class="imageblock center">
<div class="content">
<img alt="messaging" src="images/courses/DS220/transitions/messaging-transition/messaging.jpg" />
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-use-cases-messaging">
<h2>Messaging Applications</h2>
<div class="ulist">
<ul>
<li>Email</li>
<li>Instant messaging</li>
<li>Chat rooms</li>
<li>Forums</li>
<li>Tweets</li>
<li>Comments and reviews</li>
<li>Social networking (mixes text and multimedia)</li>
</ul>
</div>
</section>
<section class="slide" id="messaging-use-case-introduction">
<h2>Messaging Use Case Introduction</h2>
<div class="ulist">
<ul>
<li>A user has an email account</li>
<li>An email contains information about a sender, addressees, subject, body, and timestamp</li>
<li>A user owns predefined and user-defined folders that organize their emails</li>
<li>A user can access many emails</li>
<li>An email can be seen by many users</li>
<li>An email may have attachments</li>
</ul>
</div>
<div class="paragraph slide"><p><strong>Exercise: Sketch a conceptual model for this domain</strong></p></div>
</section>
<section class="slide" id="conceptual-model">
<h2>Conceptual Model</h2>
<div class="paragraph"><p><span class="image"><img alt="conceptual-model" src="images/cassandra/dev/data-modeling/use-cases/messaging/conceptual-model.svg" /></span></p></div>
<div class="paragraph notes"><p>Notice the use of two weak entity types. If we delete a <strong>User</strong>, we will also remove their <strong>Folder*s. The same is true with an *Email</strong>'s *Attachment*s.</p></div>
</section>
<section class="slide" id="application-queries-2">
<h2>Application Queries</h2>
<div class="ulist">
<ul>
<li>Q1: Find folders for a specific user</li>
<li>Q2: Count number of unread emails for a user&#8217;s folders</li>
<li>Q3: Retrieve emails for a specific user folder (order by timestamp)</li>
<li>Q4: Retrieve an attachment for a given email and filename</li>
</ul>
</div>
</section>
<section class="slide" id="application-workflow-2">
<h2>Application Workflow</h2>
<div class="paragraph"><p><span class="image"><img alt="application-workflow" src="images/cassandra/dev/data-modeling/use-cases/messaging/application-workflow.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Q1: Find folders for a specific user</li>
<li>Q2: Count number of unread emails for a user&#8217;s folders</li>
<li>Q3: Retrieve emails for a specific user folder (order by timestamp)</li>
<li>Q4: Retrieve an attachment for a given email and filename</li>
</ul>
</div>
<div class="paragraph slide"><p><strong>Exercise: Sketch the logical data model for this domain</strong></p></div>
<div class="paragraph notes"><p>Notice this workflow is a typical email application where the user views their folders, identifies ones with unread emails, reads those emails and views any accompanying attachments.</p></div>
</section>
<section class="slide" id="logical-data-model-2">
<h2>Logical Data Model</h2>
<div class="paragraph"><p><span class="image"><img alt="logical-data-model" src="images/cassandra/dev/data-modeling/use-cases/messaging/logical-data-model.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Q1: Find folders for a specific user</li>
<li>Q2: Count number of unread emails for a user&#8217;s folders</li>
<li>Q3: Retrieve emails for a specific user folder (order by timestamp)</li>
<li>Q4: Retrieve an attachment for a given email and filename</li>
</ul>
</div>
<div class="openblock slide">
<div class="content">
<div class="paragraph"><p>Exercise: Perform the analysis on this model in preparation for the physical data model. Consider:</p></div>
<div class="ulist">
<ul>
<li>Partition size</li>
<li>Duplication</li>
</ul>
</div>
</div>
</div>
</section>
<section class="slide" id="analysis-folders_by_user">
<h2>Analysis - folders_by_user</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="folders-by-user-logical" src="images/cassandra/dev/data-modeling/use-cases/messaging/folders-by-user-logical.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Application restricts number of user folders to 1000</li>
<li>Small partitions</li>
</ul>
</div>
</section>
<section class="slide" id="analysis-unread_emails">
<h2>Analysis - Unread_emails</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="unread-emails-logical" src="images/cassandra/dev/data-modeling/use-cases/messaging/unread-emails-logical.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>One partition per user</li>
<li>Small partitions</li>
</ul>
</div>
<div class="paragraph notes"><p>We restricted the number of folders a user may have, thus, we have small partitions.</p></div>
</section>
<section class="slide" id="analysis-emails_by_user_folder">
<h2>Analysis - emails_by_user_folder</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="emails-by-user-folder-logical" src="images/cassandra/dev/data-modeling/use-cases/messaging/emails-by-user-folder-logical.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Manageable partitions</li>
<li>Limit number of emails per folder (ex: 10,000)</li>
<li>Force archiving old messages when user reaches folder limit</li>
</ul>
</div>
</section>
<section class="slide" id="analysis-attachments_by_email">
<h2>Analysis - attachments_by_email</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="attachments-by-email-logical" src="images/cassandra/dev/data-modeling/use-cases/messaging/attachments-by-email-logical.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Partition size depends on attachment size</li>
<li>Restrict attachment size to 10MBs</li>
</ul>
</div>
</section>
<section class="slide" id="duplication">
<h2>Duplication</h2>
<div class="ulist">
<ul>
<li>How many times do we duplicate an email?</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="logical-data-model" src="images/cassandra/dev/data-modeling/use-cases/messaging/logical-data-model.svg" /></span></p></div>
<div class="paragraph notes"><p>Since Emails_by_user_folder is the only table to store email data, there is no duplication in other tables. However, when an email has multiple recipients, each recipient receives a copy of that email. We also duplicate the email for every folder (label) the user applies to an email. So there is duplication in that regard.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="attachments-by-email-logical" src="images/cassandra/dev/data-modeling/use-cases/messaging/attachments-by-email-logical.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>How many times do we duplicate an attachment?</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="attachments-by-email-logical" src="images/cassandra/dev/data-modeling/use-cases/messaging/attachments-by-email-logical.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>How many times do we duplicate an attachment?</li>
<li>Zero</li>
</ul>
</div>
<div class="paragraph notes"><p>Every email copy in Emails_by_user_folder share the same attachment data. Thus, there is no duplication within this table.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="attachments-by-email-logical" src="images/cassandra/dev/data-modeling/use-cases/messaging/attachments-by-email-logical.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>How many times do we duplicate an attachment?</li>
<li>Zero</li>
</ul>
</div>
<div class="paragraph"><p>However, to retrieve larger attachments faster, we can break them into chunks and simultaneously stream the data from multiple nodes.</p></div>
<div class="paragraph"><p>How can we tweak our schema to handle this optimization?</p></div>
</section>
<section class="slide" id="attachment-chunks">
<h2>Attachment Chunks</h2>
<div class="paragraph"><p><span class="image"><img alt="attachment-chunks" src="images/cassandra/dev/data-modeling/use-cases/messaging/attachment-chunks.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>We divide an attachment into smaller 256KB chunks and store them separately. The partitioner should evenly distribute these chunks among the nodes.</p></div>
<div class="paragraph"><p>Splitting attachments between several partitions allows streaming the value from multiple nodes simultaneously instead of waiting on a single node to deliver the larger chunk of data by itself.</p></div>
</div>
</div>
</section>
<section class="slide" id="physical-data-model-exercise">
<h2>Physical Data Model - Exercise</h2>
<div class="ulist">
<ul>
<li>Model the physical data model for this domain</li>
</ul>
</div>
</section>
<section class="slide" id="physical-data-model-solution">
<h2>Physical Data Model - Solution</h2>
<div class="paragraph"><p><span class="image"><img alt="physical-data-model" src="images/cassandra/dev/data-modeling/use-cases/messaging/physical-data-model.svg" /></span></p></div>
<div class="ulist">
<ul>
<li>Q1: Find folders for a specific user</li>
<li>Q2: Count number of unread emails for a user&#8217;s folders</li>
<li>Q3: Retrieve emails for a specific user folder (order by timestamp)</li>
<li>Q4: Retrieve an attachment for a given email and filename</li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Notice we split query four into two separate queries to divide our email attachment up between multiple nodes.</p></div>
<div class="paragraph"><p>Query 4.1 stores the number of chunks we split the attachment file into.</p></div>
<div class="paragraph"><p>Then query 4.2 retrieves each chunk keyed by email_id, filename, and chunk number.</p></div>
<div class="paragraph"><p>If all chunks were the same size, we could instead store the attachment file size and derive the value by dividing by the standard chunk size.</p></div>
</div>
</div>
</section>
<section class="slide" id="physical-data-model-cql-exercise">
<h2>Physical Data Model - CQL Exercise</h2>
<div class="ulist">
<ul>
<li>Use CQL to create the tables for this domain</li>
<li>Use CQL to write the queries for our application workflow</li>
</ul>
</div>
</section>
<section class="slide" id="physical-data-model-cql-solution">
<h2>Physical Data Model - CQL Solution</h2>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="folders-by-user-physical" src="images/cassandra/dev/data-modeling/use-cases/messaging/folders-by-user-physical.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> folders_by_user (
    user_name    <span class="predefined-type">TEXT</span>,
    label       <span class="predefined-type">TEXT</span>,
    color       <span class="predefined-type">TEXT</span>,
    name        <span class="predefined-type">TEXT</span> STATIC,
    <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((user_name), label)
);

Query <span class="integer">1</span>:
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> folders_by_user
<span class="keyword">WHERE</span> user_name = <span class="error">?</span>;</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="unread-emails-physical" src="images/cassandra/dev/data-modeling/use-cases/messaging/unread-emails-physical.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> unread_emails (
    user_name    <span class="predefined-type">TEXT</span>,
    label       <span class="predefined-type">TEXT</span>,
    total       COUNTER,
    <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((user_name), label)
);

Query <span class="integer">2</span>:
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> unread_emails
<span class="keyword">WHERE</span> user_name = <span class="error">?</span>;</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="emails-by-user-folder-physical" src="images/cassandra/dev/data-modeling/use-cases/messaging/emails-by-user-folder-physical.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> emails_by_user_folder (
    user_name   <span class="predefined-type">TEXT</span>,
    label      <span class="predefined-type">TEXT</span>,
    email_id   TIMEUUID,
    is_read    <span class="predefined-type">BOOLEAN</span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span>       LIST&lt;<span class="predefined-type">TEXT</span>&gt;,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span>     <span class="predefined-type">TEXT</span>,
    subject    <span class="predefined-type">TEXT</span>,
    body       <span class="predefined-type">TEXT</span>,
    filenames  <span class="class">SET</span>&lt;<span class="predefined-type">TEXT</span>&gt;,
    <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((user_name, label), email_id)
)
WITH CLUSTERING <span class="keyword">ORDER</span> <span class="keyword">BY</span> (email_id <span class="directive">DESC</span>);

Query <span class="integer">3</span>:
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> emails_by_user_folder
<span class="keyword">WHERE</span> user_name = <span class="error">?</span> <span class="keyword">AND</span> label = <span class="error">?</span>;</code></pre>
</div>
</div>
<div class="paragraph notes"><p><strong>to</strong> and <strong>from</strong> are both CQL keywords, so we use double quotes.</p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="attachments-by-email-physical" src="images/cassandra/dev/data-modeling/use-cases/messaging/attachments-by-email-physical.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> attachments_by_email (
    email_id   TIMEUUID,
    filename   <span class="predefined-type">TEXT</span>,
    n_chunks   <span class="predefined-type">INT</span>,
    type       <span class="predefined-type">TEXT</span>,
    <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((email_id, filename))
);

Query <span class="float">4.1</span>:
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> attachments_by_email
<span class="keyword">WHERE</span> email_id = <span class="error">?</span> <span class="keyword">AND</span> filename = <span class="error">?</span>;</code></pre>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image" style="float: right"><img alt="chunks-by-attachment-physical" src="images/cassandra/dev/data-modeling/use-cases/messaging/chunks-by-attachment-physical.svg" /></span></p></div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">CREATE</span> <span class="type">TABLE</span> chunks_by_attachment (
    email_id   TIMEUUID,
    filename   <span class="predefined-type">TEXT</span>,
    chunk      <span class="predefined-type">INT</span>,
    value      <span class="predefined-type">BLOB</span>,
    <span class="directive">PRIMARY</span> <span class="type">KEY</span> ((email_id, filename, chunk))
);

Query <span class="float">4.2</span>:
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> chunks_by_attachment
<span class="keyword">WHERE</span> email_id = <span class="error">?</span> <span class="keyword">AND</span> filename = <span class="error">?</span> <span class="keyword">AND</span> chunk = <span class="error">?</span>;</code></pre>
</div>
</div>
</section>
<section class="slide transition-green" id="courses-DS220-transitions-multi-tenancy-transition">
<h2>Multi-Tenancy Use Case</h2>
<div class="imageblock" style="float: ">
<div class="content">
<img alt="multi tenancy" src="images/courses/DS220/transitions/multi-tenancy-transition/multi-tenancy.jpg" />
</div>
</div>
</section>
<section class="slide" id="cassandra-dev-data-modeling-use-cases-multi-tenancy">
<h2>Multi Tenancy</h2>
<div class="ulist">
<ul>
<li>Single Cassandra cluster serves multiple organizations (tenants)</li>
<li>Storage as a Service</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="multiple-clients" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/multiple-clients.svg" /></span></p></div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Similar to an apartment complex housing several tenants, multi-tenancy hosts separate but similar organizations using one Cassandra cluster.</p></div>
<div class="paragraph"><p>Use multi-tenancy techniques when you have several clients that want to subscribe to your services. Multi-tenancy techniques isolate each client&#8217;s data from each other. Clients can use the database as if they are the only one present, blissfully unaware that other tenants exist.</p></div>
</div>
</div>
</section>
<section class="slide" id="sample-schema">
<h2>Sample Schema</h2>
<div class="ulist">
<ul>
<li>We will use sensor data as the basis for our multi-tenancy example</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="sensor-data-physical-model" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/sensor-data-physical-model.svg" /></span></p></div>
<div class="paragraph notes"><p>This is the physical model for the sensor-data use case. Understanding that use case is helpful but not required for this use case.</p></div>
</section>
<section class="slide" id="classic-multi-tenancy-models">
<h2>Classic Multi-Tenancy Models</h2>
<div class="paragraph"><p><strong>Pros and cons to each of these approaches</strong></p></div>
<table class="tableblock frame-all grid-all" style="width:100%">
<colgroup>
<col style="width:25%" />
<col style="width:25%" />
<col style="width:25%" />
<col style="width:25%" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Approach</th>
<th class="tableblock halign-left valign-top">Table</th>
<th class="tableblock halign-left valign-top">Keyspace</th>
<th class="tableblock halign-left valign-top">Cassandra Instance</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared Table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared Keyspace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2715;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared Cassandra Instance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2715;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2715;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
</tr>
</tbody>
</table>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>There are three classic multi-tenancy approaches, adapted here some for Cassandra.</p></div>
<div class="paragraph"><p><strong>Shared Table</strong> has tenants share all database objects (tables, keyspaces, and Cassandra instances).</p></div>
<div class="paragraph"><p><strong>Shared Keyspace</strong> has tenants not share tables, but they do share keyspaces and Cassandra instances. Relational database developers refer to this technique as <em>shared schema</em>.</p></div>
<div class="paragraph"><p><strong>Shared Cassandra Instance</strong> only has tenants share a Cassandra cluster, but not keyspaces nor tables.</p></div>
</div>
</div>
</section>
<section class="slide" id="shared-table">
<h2>Shared Table</h2>
<div class="ulist">
<ul>
<li>Add <em>tenant</em> to each table&#8217;s partition key</li>
<li>Tenants share tables but not partitions</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="shared-table-tenant" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-table-tenant.svg" /></span></p></div>
<div class="paragraph notes"><p>To share tables amongst tenants, simply put a <em>tenant</em> identifier (UUID) in every table&#8217;s partition key. Tenants share tables but not partitions.</p></div>
</section>
<section class="slide" id="shared-table-2">
<h2>Shared Table</h2>
<div class="paragraph"><p><span class="image"><img alt="shared-table-query-rewriting-1" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-table-query-rewriting-1.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="shared-table-query-rewriting-2" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-table-query-rewriting-2.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="shared-table-query-rewriting-3" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-table-query-rewriting-3.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="shared-table-query-rewriting-4" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-table-query-rewriting-4.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="shared-table-query-rewriting-5" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-table-query-rewriting-5.svg" /></span></p></div>
<div class="paragraph notes"><p>Both tenants submit syntactically similar queries, unaware that either exists. Your application server acts as a proxy isolating tenants from each other by rewriting their queries with the appropriate <em>tenant</em> value.</p></div>
</section>
<section class="slide" id="shared-table-3">
<h2>Shared Table</h2>
<div class="ulist">
<ul>
<li><p>
Characteristics<div class="ulist">
<ul>
<li>Tenants require similar schemas (tables and columns)</li>
<li>Tenants share the same data structure (SSTables, MemTables, caches)</li>
<li>Application manages data isolation</li>
</ul>
</div></p></li>
<li><p>
Advantages<div class="ulist">
<ul>
<li>Low total cost of operation</li>
<li>Efficient and scalable</li>
</ul>
</div></p></li>
<li><p>
Limitations<div class="ulist">
<ul>
<li>Active tenants will "overwhelm" key and row caches</li>
<li>Active tenants may be responsible for most compactions</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>If tenants require different table schemas, then shared table is not an option. However, if all tenants can share the same table schema, then shared table is simple to implement and ideal.</p></div>
<div class="paragraph"><p>Shared table is simple to implement and does not require much configuration beyond the <em>tenant</em> column in the partition key. It also scales with the number of nodes in the Cassandra instance.</p></div>
<div class="paragraph"><p>If tenant A requests just a few records per second, and tenant B requests thousands of records per second, tenant B&#8217;s data will dominate the caches because tenants its data is the most active. Tenant A&#8217;s requests will then require disk access.</p></div>
<div class="paragraph"><p>More active tenants also trigger compactions to occur more often causing latency for less active tenants.</p></div>
</div>
</div>
</section>
<section class="slide" id="shared-keyspace">
<h2>Shared Keyspace</h2>
<div class="paragraph"><p><strong>Tenants share a keyspace but not tables</strong></p></div>
<div class="paragraph"><p><span class="image"><img alt="shared-keyspace" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-keyspace.svg" /></span></p></div>
</section>
<section class="slide" id="shared-keyspace-2">
<h2>Shared Keyspace</h2>
<div class="paragraph"><p><strong>Characteristics</strong></p></div>
<div class="ulist">
<ul>
<li>Tenants may use different schemas</li>
<li>Tenants do not share same physical data structure (SSTables, MemTables)</li>
</ul>
</div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><strong>Characteristics</strong></p></div>
<div class="ulist">
<ul>
<li>Cassandra can manage data isolation instead of the application</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay"><code class="sql language-sql"><span class="class">GRANT</span> <span class="keyword">ALL</span> PERMISSIONS
<span class="keyword">ON</span> keyspace_sensor.networks_a <span class="keyword">TO</span> tenant_a;

<span class="class">GRANT</span> <span class="keyword">ALL</span> PERMISSIONS
<span class="keyword">ON</span> keyspace_sensor.networks_b <span class="keyword">TO</span> tenant_b;</code></pre>
</div>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Tenants can add add or remove columns and tables to customize their schema.</p></div>
<div class="paragraph"><p>Cassandra has various options for setting security at either the keyspace or table level. Setting up separate clusters is the ultimate security strategy if needs be.</p></div>
</div>
</div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Application can also optionally rewrite queries instead of using Cassandra-managed permissions</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="shared-keyspace-query-rewriting-1" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-keyspace-query-rewriting-1.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Application can also optionally rewrite queries instead of using Cassandra-managed permissions</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="shared-keyspace-query-rewriting-2" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-keyspace-query-rewriting-2.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Application can also optionally rewrite queries instead of using Cassandra-managed permissions</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="shared-keyspace-query-rewriting-3" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-keyspace-query-rewriting-3.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Application can also optionally rewrite queries instead of using Cassandra-managed permissions</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="shared-keyspace-query-rewriting-4" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-keyspace-query-rewriting-4.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li>Application can also optionally rewrite queries instead of using Cassandra-managed permissions</li>
</ul>
</div>
<div class="paragraph"><p><span class="image"><img alt="shared-keyspace-query-rewriting-5" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-keyspace-query-rewriting-5.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li><p>
Advantages<div class="ulist">
<ul>
<li>Data isolation in the file system and memory</li>
<li>Different schemas can support different applications</li>
</ul>
</div></p></li>
<li><p>
Limitations<div class="ulist">
<ul>
<li>Limited scalability in terms of the number of tables</li>
<li>Each table requires on-heap memory for MemTable</li>
</ul>
</div></p></li>
</ul>
</div>
<div class="openblock notes">
<div class="content">
<div class="paragraph"><p>Each table has its own files, so an active tenant no longer slows an inactive tenant&#8217;s requests.</p></div>
<div class="paragraph"><p>Tenants are also free to modify their schema how they wish.</p></div>
<div class="paragraph"><p>Cassandra tables have overhead no matter their size. Ideally you will have no more than a few hundred tables. If you have a lot of tenants, you will eventually run out of memory.</p></div>
</div>
</div>
</section>
<section class="slide" id="scaling-shared-keyspace">
<h2>Scaling Shared Keyspace</h2>
<div class="paragraph"><p><span class="image"><img alt="tenant-abc" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/tenant-abc.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="tenant-def" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/tenant-def.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="tenant-g" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/tenant-g.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="tenant-h" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/tenant-h.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="paragraph"><p><span class="image"><img alt="add-more-clusters" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/add-more-clusters.svg" /></span></p></div>
<div class="paragraph notes"><p>Recall that each table requires overhead. Thus, to scale shared keyspace and/or shared instance, you must add clusters and divide your tenants up amongst them.</p></div>
</section>
<section class="slide" id="shared-cassandra-instance">
<h2>Shared Cassandra Instance</h2>
<div class="paragraph"><p><strong>Tenants share the Cassandra cluster but not keyspaces or tables</strong></p></div>
<div class="paragraph"><p><span class="image"><img alt="shared-cassandra-instance" src="images/cassandra/dev/data-modeling/use-cases/multi-tenancy/shared-cassandra-instance.svg" /></span></p></div>
<div style="page-break-after: always"></div>
<div class="ulist">
<ul>
<li><p>
Characteristics<div class="ulist">
<ul>
<li>Same as the Shared Keyspace Approach</li>
</ul>
</div></p></li>
<li><p>
Advantages<div class="ulist">
<ul>
<li>Same as the Shared Keyspace Approach</li>
<li>In addition, tenants may use different replication settings per keyspace</li>
<li>Lower paying tenants can be in low replication keyspace and vice versa for higher paying tenants</li>
</ul>
</div></p></li>
<li><p>
Limitations<div class="ulist">
<ul>
<li>Same as the Shared Keyspace Approach</li>
<li>Multiple keyspaces do not have a significant overhead for Cassandra (unlike tables)</li>
</ul>
</div></p></li>
<li>Tenant driver with multiple keyspaces may use the same session</li>
</ul>
</div>
<div class="paragraph notes"><p>The key deciding factor between shared keyspace vs. shared Cassandra instance is whether tenants require separate replication levels. You set replication on a keyspace level, thus tenants must have their own keyspace if they have differing replication factors. You may also wish to charge higher replication tenants more for such additional resource use.</p></div>
</section>
<section class="slide" id="review">
<h2>Review</h2>
<table class="tableblock frame-all grid-all" style="width:100%">
<colgroup>
<col style="width:25%" />
<col style="width:25%" />
<col style="width:25%" />
<col style="width:25%" />
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Approach</th>
<th class="tableblock halign-left valign-top">Table</th>
<th class="tableblock halign-left valign-top">Keyspace</th>
<th class="tableblock halign-left valign-top">Cassandra Instance</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared Table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared keyspace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2715;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shared Cassandra Instance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2715;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2715;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#x2714;</p></td>
</tr>
</tbody>
</table>
</section>
<div aria-role="navigation">
<a class="deck-prev-link" href="#" title="Previous">
<i class="icon-chevron-with-circle-left"></i>
</a>
<a class="deck-next-link" href="#" title="Next">
<i class="icon-chevron-with-circle-right"></i>
</a>
</div>
<form action="." class="goto-form" method="get">
<label for="goto-slide">Go to Slide:</label>
<input id="goto-slide" list="goto-datalist" name="slidenum" type="text" />
<datalist id="goto-data-list"></datalist>
<input type="submit" value="Go" />
</form>
</div>
<script src="deck.js/jquery.min.js"></script>
<script src="deck.js/d3.v2.js"></script>
<script src="deck.js/jquery-ui.min.js"></script>
<script src="deck.js/core/deck.core.js"></script>
<script src="deck.js/extensions/scale/deck.scale.js"></script>
<script src="deck.js/extensions/goto/deck.goto.js"></script>
<script src="deck.js/extensions/navigation/deck.navigation.js"></script>
<script src="deck.js/extensions/split/deck.split.js"></script>
<script src="deck.js/extensions/animation/deck.animation.js"></script>
<script src="deck.js/extensions/deck.js-notes/deck.notes.js"></script>
<script src="deck.js/extensions/goto/deck.goto.js"></script>
<script src="deck.js/extensions/clone/deck.clone.js"></script>
<script src="deck.js/extensions/svg/svg.min.js"></script>
<script src="js/course.js"></script>
<footer>
<div class="flex-element deck-course">
<p>&copy; 2016 DataStax. Use only with permission. &bull;
<span class="course-title">DS220: Data Modeling</span></p>
</div>
<div class="flex-element deck-brand">
<a href="http://academy.datastax.com" target="blank">DataStax Academy</a>
</div>
<div class="deck-progressbar">
<span></span>
</div>
</footer>
<script type="text/javascript">
  //<![CDATA[
    (function($, deck, undefined) {
      $.deck.defaults.keys['previous'] = [8, 33, 37, 39];
      $.deck.defaults.keys['next'] = [13, 32, 34, 39];
    
      $.extend(true, $[deck].defaults, {
          countNested: false
      });
    
      $.deck('.slide');
      $.deck('disableScale');
    })(jQuery, 'deck');
  //]]>
</script>
<script type="text/javascript">
  //<![CDATA[
    $(document).bind('deck.change', function(event, from, to) {
      var width = to / ($.deck('getSlides').length - 1) * 100;
      $('.deck-progressbar span').css('width', width + '%');
    });
  //]]>
</script>
</body>
</html>